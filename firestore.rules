rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Fonction helper: vérifier si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }

    // Fonction helper: vérifier si c'est le propriétaire
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Fonction helper: validation des données utilisateur
    function isValidUserData() {
      let data = request.resource.data;
      return data.keys().hasAll(['email', 'firstName', 'createdAt']) &&
             data.email is string &&
             data.firstName is string &&
             data.email.size() > 0 &&
             data.firstName.size() > 0;
    }

    // --- RÈGLES POUR LES UTILISATEURS ---
    match /users/{userId} {
      // Lecture: autorisée pour l'utilisateur lui-même
      allow read: if isOwner(userId);

      // Création: autorisée uniquement pour son propre compte avec validation
      allow create: if isOwner(userId) && isValidUserData();

      // Mise à jour: autorisée uniquement pour son propre compte
      // Ne peut pas modifier email et createdAt
      allow update: if isOwner(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['email', 'createdAt']);

      // Suppression: autorisée uniquement pour son propre compte
      allow delete: if isOwner(userId);

      // --- SOUS-COLLECTIONS ---

      // Cours de l'utilisateur
      match /courses/{courseId} {
        allow read, write: if isOwner(userId);
      }

      // Dossiers de l'utilisateur
      match /folders/{folderId} {
        allow read, write: if isOwner(userId);
      }

      // Quiz de l'utilisateur
      match /quizzes/{quizId} {
        allow read, write: if isOwner(userId);
      }

      // Synthèses de l'utilisateur
      match /syntheses/{synthesisId} {
        allow read, write: if isOwner(userId);
      }

      // Notifications de l'utilisateur
      match /notifications/{notifId} {
        allow read, update, delete: if isOwner(userId);
        // Création réservée aux Cloud Functions
        allow create: if false;
      }
    }

    // --- RÈGLES POUR LES COMMUNAUTÉS (si implémenté) ---
    match /communities/{communityId} {
      // Lecture publique des communautés
      allow read: if isAuthenticated();

      // Création: nécessite authentification
      allow create: if isAuthenticated() &&
                       request.resource.data.ownerId == request.auth.uid;

      // Mise à jour/suppression: uniquement par le propriétaire
      allow update, delete: if isAuthenticated() &&
                               resource.data.ownerId == request.auth.uid;

      // Messages de la communauté
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() &&
                         request.resource.data.authorId == request.auth.uid;
        allow update, delete: if isAuthenticated() &&
                                 resource.data.authorId == request.auth.uid;
      }
    }

    // --- RÈGLES POUR LES STATISTIQUES GLOBALES (lecture seule) ---
    match /stats/{statId} {
      allow read: if true; // Public
      allow write: if false; // Uniquement via Cloud Functions
    }

    // --- BLOQUER TOUT LE RESTE ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
