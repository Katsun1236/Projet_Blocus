rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isResourceOwner() {
      return isAuthenticated() && request.auth.uid == resource.data.userId;
    }

    function isAuthor() {
      return isAuthenticated() && request.auth.uid == resource.data.authorId;
    }

    function willBeAuthor() {
      return isAuthenticated() && request.auth.uid == request.resource.data.authorId;
    }

    function isValidString(field, maxLength) {
      return request.resource.data[field] is string &&
             request.resource.data[field].size() <= maxLength;
    }

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);

      match /courses/{courseId} {
        allow read, write: if isOwner(userId);
      }

      match /quizzes/{quizId} {
        allow read, write: if isOwner(userId);
      }

      match /syntheses/{synthesisId} {
        allow read, write: if isOwner(userId);
      }

      match /events/{eventId} {
        allow read, write: if isOwner(userId);
      }

      match /planning/{eventId} {
        allow read, write: if isOwner(userId);
      }
    }

    match /community_posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                     willBeAuthor() &&
                     isValidString('title', 200) &&
                     isValidString('content', 10000);
      allow update: if isAuthor() &&
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likesBy', 'commentsCount']) ||
                       (isValidString('title', 200) && isValidString('content', 10000)));
      allow delete: if isAuthor();

      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() &&
                       willBeAuthor() &&
                       isValidString('content', 2000);
        allow update, delete: if isAuthor();
      }

      match /likes/{likeId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isOwner(likeId);
        allow delete: if isOwner(likeId);
      }
    }

    match /groups/{groupId} {
      allow read: if isAuthenticated() &&
        (request.auth.uid in resource.data.members ||
         resource.data.visibility == 'public');
      allow create: if isAuthenticated() &&
                     isValidString('name', 100) &&
                     request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() &&
        (request.auth.uid == resource.data.ownerId ||
         request.auth.uid in resource.data.admins);
      allow delete: if isAuthenticated() &&
        request.auth.uid == resource.data.ownerId;

      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
        allow create: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members &&
          willBeAuthor();
        allow delete: if isAuthor() ||
          request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins;
      }

      match /files/{fileId} {
        allow read: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
        allow create: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members &&
          request.resource.data.userId == request.auth.uid;
        allow delete: if isResourceOwner() ||
          request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins;
      }
    }

    match /quiz_results/{resultId} {
      allow read: if isAuthenticated() &&
        (isResourceOwner() || resource.data.visibility == 'public');
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isResourceOwner();
    }

    match /forum/{discussionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && willBeAuthor();
      allow update: if isAuthor();
      allow delete: if isAuthor();

      match /replies/{replyId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && willBeAuthor();
        allow update, delete: if isAuthor();
      }
    }

    match /friendships/{friendshipId} {
      allow read: if isAuthenticated() &&
        (request.auth.uid in [resource.data.user1Id, resource.data.user2Id]);
      allow create: if isAuthenticated() &&
        request.auth.uid in [request.resource.data.user1Id, request.resource.data.user2Id];
      allow update, delete: if isAuthenticated() &&
        request.auth.uid in [resource.data.user1Id, resource.data.user2Id];
    }

    match /sharedContent/{contentId} {
      allow read: if isAuthenticated() &&
        (isResourceOwner() || resource.data.sharedWith == 'public' ||
         request.auth.uid in resource.data.sharedWith);
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isResourceOwner();
    }

    match /chats/{chatId} {
      allow read: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow create: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
          request.resource.data.senderId == request.auth.uid;
        allow update, delete: if request.auth.uid == resource.data.senderId;
      }
    }

    match /reports/{reportId} {
      allow read: if false;
      allow create: if isAuthenticated() &&
        request.resource.data.reporterId == request.auth.uid;
      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
