<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz IA - Projet Blocus</title>
    <link rel="icon" type="image/png" href="../../assets/images/logo.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    
    <style>
        .content-glass {
            background: rgba(20, 20, 20, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .quiz-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px -10px rgba(79, 70, 229, 0.3);
        }
        /* Animation pour le loader IA */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .pulse-ring::before {
            content: '';
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            border-radius: 50%;
            border: 2px solid #6366f1;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
    </style>
</head>

<body id="app-container" class="relative selection:bg-indigo-500 selection:text-white overflow-hidden h-screen flex bg-[#050505]">

    <!-- FOND ANIMÉ -->
    <div class="noise-overlay"></div>
    <div class="glow-bg" style="top: -10%; right: 20%; background: radial-gradient(circle, rgba(168, 85, 247, 0.1) 0%, transparent 60%);"></div>
    <div class="glow-bg" style="bottom: 10%; left: -5%; background: radial-gradient(circle, rgba(79, 70, 229, 0.1) 0%, transparent 60%);"></div>

    <!-- MAIN CONTENT -->
    <div class="flex-grow flex flex-col min-w-0 relative z-10 md:ml-64 transition-all duration-300">
        
        <!-- HEADER HARMONISÉ -->
        <header class="h-20 border-b border-gray-800/50 flex items-center justify-between px-8 bg-gray-900/30 backdrop-blur-sm z-30 sticky top-0">
            <div class="flex items-center gap-4">
                <button id="mobile-menu-btn" class="md:hidden text-gray-400 hover:text-white"><i class="fas fa-bars text-xl"></i></button>
                <div class="hidden md:block">
                    <h1 class="text-xl font-display font-bold text-white">Quiz Intelligence Artificielle</h1>
                    <p class="text-sm text-gray-400">Teste tes connaissances</p>
                </div>
                <span class="md:hidden text-white font-bold">Quiz IA</span>
            </div>

            <div class="flex items-center gap-6">
                <!-- Bouton Création Rapide -->
                <button id="btn-new-quiz-header" class="hidden sm:flex bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg shadow-indigo-500/20 transition-all items-center gap-2">
                    <i class="fas fa-brain"></i> <span>Générer un Quiz</span>
                </button>

                <div class="h-8 w-px bg-gray-800 hidden sm:block"></div>

                <!-- Notifications -->
                <div class="relative">
                    <button id="notif-btn" class="relative text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-white/5 outline-none">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notif-badge" class="absolute top-1.5 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-gray-900 hidden transform scale-100 transition-transform"></span>
                    </button>
                    <!-- Dropdown Notifs -->
                    <div id="notif-dropdown" class="hidden absolute right-0 mt-4 w-80 bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl overflow-hidden z-50">
                        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/95 backdrop-blur">
                            <h3 class="font-bold text-white text-sm">Notifications</h3>
                        </div>
                        <div id="notifications-list" class="max-h-[300px] overflow-y-auto p-4 text-center text-gray-500 text-sm">
                            <p>Aucune nouvelle notification</p>
                        </div>
                    </div>
                </div>

                <!-- Profil -->
                <a href="profile.html" class="flex items-center gap-3 group cursor-pointer pl-2">
                    <div class="text-right hidden sm:block">
                        <p id="user-name-header" class="text-sm font-bold text-white group-hover:text-indigo-400 transition-colors">...</p>
                        <p class="text-xs text-gray-500">Étudiant</p>
                    </div>
                    <img id="user-avatar-header" src="" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-gray-700 group-hover:border-indigo-500 transition-colors object-cover bg-gray-800">
                </a>
            </div>
        </header>

        <!-- CONTENU SCROLLABLE -->
        <main class="flex-grow p-6 overflow-y-auto custom-scrollbar">
            
            <!-- SECTION 1: STATS & ACTION -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
                
                <!-- Carte Génération (Large) -->
                <div class="lg:col-span-2 relative overflow-hidden rounded-2xl bg-gradient-to-br from-indigo-900/40 to-purple-900/40 border border-indigo-500/20 p-8 flex flex-col justify-center items-start group">
                    <div class="absolute right-0 top-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                    
                    <div class="relative z-10">
                        <span class="inline-block px-3 py-1 rounded-full bg-indigo-500/20 text-indigo-300 text-xs font-bold mb-3 border border-indigo-500/20">
                            <i class="fas fa-sparkles mr-1"></i> Propulsé par Gemini 2.0 Flash
                        </span>
                        <h2 class="text-3xl font-display font-bold text-white mb-2">Génère un quiz infini</h2>
                        <p class="text-gray-300 mb-6 max-w-lg">Importe tes cours ou choisis un sujet. L'IA va créer des questions sur mesure pour tester tes connaissances instantanément.</p>
                        
                        <button id="btn-new-quiz-hero" class="bg-white text-indigo-900 hover:bg-gray-100 px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-900/20 transition-all transform hover:scale-105 flex items-center gap-2">
                            <i class="fas fa-play"></i> Commencer un Quiz
                        </button>
                    </div>
                    
                    <!-- Illustration Décorative -->
                    <div class="absolute right-8 bottom-8 opacity-50 group-hover:opacity-80 transition-opacity duration-500 hidden sm:block">
                        <i class="fas fa-brain text-9xl text-indigo-500/20"></i>
                    </div>
                </div>

                <!-- Stats Rapides -->
                <div class="grid grid-rows-2 gap-6">
                    <div class="content-glass p-6 rounded-2xl flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Moyenne Globale</p>
                            <h3 class="text-3xl font-bold text-white mt-1" id="stat-avg-score">--%</h3>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-green-500/10 flex items-center justify-center text-green-400">
                            <i class="fas fa-chart-line text-xl"></i>
                        </div>
                    </div>
                    <div class="content-glass p-6 rounded-2xl flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Quiz Complétés</p>
                            <h3 class="text-3xl font-bold text-white mt-1" id="stat-total-quiz">--</h3>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400">
                            <i class="fas fa-check-double text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: FILTRES & LISTE -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Mes Quiz Récents</h2>
                <div class="flex gap-2 p-1 bg-gray-900/50 rounded-lg border border-gray-800">
                    <button class="px-3 py-1.5 rounded-md text-xs font-medium text-white bg-gray-700 shadow-sm">Tous</button>
                    <button class="px-3 py-1.5 rounded-md text-xs font-medium text-gray-400 hover:text-white transition-colors">Terminés</button>
                </div>
            </div>

            <div id="quiz-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Loader Squelette -->
                <div class="content-glass rounded-2xl p-6 h-48 animate-pulse flex flex-col justify-between">
                    <div class="w-12 h-12 bg-gray-800 rounded-lg mb-4"></div>
                    <div class="space-y-2">
                        <div class="h-4 bg-gray-800 rounded w-3/4"></div>
                        <div class="h-3 bg-gray-800 rounded w-1/2"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: NOUVEAU QUIZ -->
    <div id="new-quiz-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-gray-800/50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-indigo-600/20 flex items-center justify-center text-indigo-400">
                        <i class="fas fa-magic"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white">Configuration du Quiz</h3>
                        <p class="text-xs text-gray-400">Paramètre ton entraînement</p>
                    </div>
                </div>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-6">
                
                <!-- 1. Source -->
                <div class="space-y-3">
                    <label class="text-sm font-medium text-gray-300 uppercase tracking-wider">Source du contenu</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="cursor-pointer relative">
                            <input type="radio" name="quiz-source" value="topic" class="peer sr-only" checked>
                            <div class="p-4 rounded-xl border border-gray-700 bg-gray-800/50 peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 transition-all hover:bg-gray-800">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-comment-dots text-indigo-400"></i>
                                    <span class="font-bold text-white">Sujet libre</span>
                                </div>
                                <p class="text-xs text-gray-400">Tape un sujet, l'IA improvise.</p>
                            </div>
                        </label>
                        <label class="cursor-pointer relative">
                            <input type="radio" name="quiz-source" value="file" class="peer sr-only">
                            <div class="p-4 rounded-xl border border-gray-700 bg-gray-800/50 peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 transition-all hover:bg-gray-800">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-file-alt text-purple-400"></i>
                                    <span class="font-bold text-white">Mes Cours</span>
                                </div>
                                <p class="text-xs text-gray-400">Utilise un fichier PDF existant.</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Input Sujet (Visible si Sujet libre) -->
                <div id="source-topic-container" class="space-y-2">
                    <label class="text-sm text-gray-400">Sujet du quiz</label>
                    <input type="text" id="quiz-topic" placeholder="Ex: La Révolution Française, Droit Constitutionnel..." 
                        class="w-full bg-black/20 border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                </div>

                <!-- Select Fichier (Visible si Fichier) -->
                <div id="source-file-container" class="space-y-2 hidden">
                    <label class="text-sm text-gray-400">Choisir un fichier</label>
                    <select id="quiz-file-select" class="w-full bg-black/20 border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                        <option value="">Chargement de tes cours...</option>
                    </select>
                </div>

                <!-- 2. Options -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400">Difficulté</label>
                        <select id="quiz-difficulty" class="w-full bg-black/20 border border-gray-700 rounded-xl px-4 py-3 text-white outline-none">
                            <option value="facile">Facile (Révision)</option>
                            <option value="moyen" selected>Moyen (Standard)</option>
                            <option value="difficile">Difficile (Expert)</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400">Nombre de questions</label>
                        <div class="flex items-center gap-4 bg-black/20 border border-gray-700 rounded-xl px-4 py-3">
                            <input type="range" id="quiz-length" min="5" max="20" step="5" value="10" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                            <span class="text-white font-bold min-w-[20px]" id="quiz-length-val">10</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-800 bg-gray-800/50 flex justify-end gap-3">
                <button id="cancel-quiz-btn" class="px-5 py-2.5 rounded-xl text-gray-400 hover:text-white hover:bg-gray-700 transition-colors font-medium">Annuler</button>
                <button id="generate-quiz-btn" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold hover:shadow-lg hover:shadow-indigo-500/25 transition-all flex items-center gap-2">
                    <i class="fas fa-bolt"></i> Générer
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed top-4 right-4 z-50"></div>

    <script type="module">
        import { auth, db } from '../../assets/js/config.js';
        import { initLayout } from '../../assets/js/layout.js';
        import { showMessage, formatDate } from '../../assets/js/utils.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { collection, query, where, getDocs, addDoc, orderBy, serverTimestamp, doc, getDoc, deleteDoc, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --- CONSTANTS ---
        const apiKey = "AIzaSyBkLY1F5uDZDiNKG1kGXC81cTbQ90uybuk"; // CLE API GEMINI INTEGREE
        let currentUserId = null;

        // --- DOM Elements ---
        const ui = {
            quizGrid: document.getElementById('quiz-grid'),
            statAvg: document.getElementById('stat-avg-score'),
            statTotal: document.getElementById('stat-total-quiz'),
            // Header User
            userName: document.getElementById('user-name-header'),
            userAvatar: document.getElementById('user-avatar-header'),
            notifBtn: document.getElementById('notif-btn'),
            notifBadge: document.getElementById('notif-badge'),
            notifDropdown: document.getElementById('notif-dropdown'),
            notifList: document.getElementById('notifications-list'),
            // Modal
            modal: document.getElementById('new-quiz-modal'),
            btnOpenHero: document.getElementById('btn-new-quiz-hero'),
            btnOpenHeader: document.getElementById('btn-new-quiz-header'),
            btnClose: document.getElementById('close-modal-btn'),
            btnCancel: document.getElementById('cancel-quiz-btn'),
            btnGenerate: document.getElementById('generate-quiz-btn'),
            // Form
            sourceRadios: document.getElementsByName('quiz-source'),
            topicContainer: document.getElementById('source-topic-container'),
            fileContainer: document.getElementById('source-file-container'),
            fileSelect: document.getElementById('quiz-file-select'),
            difficultySelect: document.getElementById('quiz-difficulty'),
            rangeInput: document.getElementById('quiz-length'),
            rangeVal: document.getElementById('quiz-length-val'),
            topicInput: document.getElementById('quiz-topic')
        };

        document.addEventListener('DOMContentLoaded', () => {
            initLayout('quiz');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    await initPage(user);
                    loadQuizzes(); // Charge les quiz ET met à jour les stats
                    loadUserFiles(); 
                    setupNotifications(currentUserId);
                } else {
                    window.location.href = '../auth/login.html';
                }
            });
        });

        async function initPage(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUserId));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    ui.userName.textContent = data.firstName || user.displayName;
                    ui.userAvatar.src = data.photoURL || user.photoURL || 'https://ui-avatars.com/api/?background=random';
                }
            } catch (e) { console.log("Info user bg load error", e); }
        }

        // --- CHARGEMENT DES QUIZ & CALCUL DES STATS ---
        async function loadQuizzes() {
            try {
                const q = query(collection(db, 'users', currentUserId, 'quizzes'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                ui.quizGrid.innerHTML = '';

                let totalScore = 0;
                let completedQuizCount = 0;
                let totalQuizCount = snapshot.size;

                if (snapshot.empty) {
                    ui.quizGrid.innerHTML = `
                        <div class="col-span-full py-12 text-center flex flex-col items-center justify-center opacity-50">
                            <i class="fas fa-ghost text-6xl mb-4 text-gray-600"></i>
                            <p class="text-gray-400 text-lg">Aucun quiz pour le moment.</p>
                            <p class="text-sm text-gray-500">Lance une génération pour commencer !</p>
                        </div>
                    `;
                    // Reset stats UI
                    ui.statAvg.textContent = "--%";
                    ui.statTotal.textContent = "0";
                    return;
                }

                snapshot.forEach(docSnap => {
                    const quiz = docSnap.data();
                    
                    // Calcul Stats Dynamique
                    if (quiz.score !== undefined && quiz.score !== null) {
                        totalScore += quiz.score;
                        completedQuizCount++;
                    }

                    // Rendu UI
                    const score = quiz.score !== undefined ? `${quiz.score}%` : 'En attente';
                    const scoreColor = quiz.score >= 80 ? 'text-green-400' : (quiz.score >= 50 ? 'text-yellow-400' : 'text-gray-400');
                    const dateStr = formatDate(quiz.createdAt);

                    const el = document.createElement('div');
                    el.className = 'quiz-card content-glass rounded-2xl p-6 flex flex-col justify-between h-full relative group cursor-pointer transition-all border border-gray-800 hover:border-indigo-500/30';
                    el.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white shadow-lg">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <span class="px-3 py-1 rounded-full bg-gray-800 text-xs font-medium ${scoreColor} border border-gray-700">
                                    ${score}
                                </span>
                            </div>
                            <h3 class="font-bold text-white text-lg mb-1 line-clamp-1">${quiz.topic || 'Quiz Général'}</h3>
                            <p class="text-xs text-gray-400 mb-4 flex items-center gap-2">
                                <i class="far fa-clock"></i> ${dateStr} • ${quiz.questions ? quiz.questions.length : 0} questions
                            </p>
                        </div>
                        <div class="flex justify-between items-center mt-auto pt-4 border-t border-gray-800">
                            <span class="text-xs text-indigo-400 font-medium group-hover:text-indigo-300 transition-colors">
                                ${quiz.status === 'completed' ? 'Revoir les résultats' : 'Commencer'}
                            </span>
                            <i class="fas fa-arrow-right text-gray-500 group-hover:text-white transition-colors transform group-hover:translate-x-1"></i>
                        </div>
                    `;
                    ui.quizGrid.appendChild(el);
                });

                // Mise à jour des Stats dans le DOM
                ui.statTotal.textContent = completedQuizCount;
                if (completedQuizCount > 0) {
                    const avg = Math.round(totalScore / completedQuizCount);
                    ui.statAvg.textContent = `${avg}%`;
                } else {
                    ui.statAvg.textContent = "--%";
                }

            } catch (error) {
                console.error("Erreur chargement quiz:", error);
                ui.quizGrid.innerHTML = '<p class="text-red-400">Erreur de chargement.</p>';
            }
        }

        // --- GENERATION AVEC GEMINI ---
        async function generateQuiz(topic, count, difficulty) {
            const prompt = `
                Tu es un professeur expert. Génère un quiz QCM (Questionnaire à Choix Multiples) en format JSON strict.
                
                Sujet : "${topic}"
                Nombre de questions : ${count}
                Difficulté : ${difficulty}
                Langue : Français

                Structure JSON attendue (tableau d'objets) :
                {
                    "questions": [
                        {
                            "question": "L'intitulé de la question",
                            "options": ["Choix A", "Choix B", "Choix C", "Choix D"],
                            "correctAnswer": 0, // Index de la bonne réponse (0-3)
                            "explanation": "Brève explication de la réponse"
                        }
                    ]
                }
                
                Ne donne QUE le JSON, pas de texte avant ou après.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json"
                        }
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                
                const rawText = data.candidates[0].content.parts[0].text;
                const parsed = JSON.parse(rawText);
                
                return parsed.questions || parsed; // Gère si l'IA renvoie directement le tableau ou l'objet wrapper

            } catch (error) {
                console.error("Erreur Gemini:", error);
                throw error;
            }
        }

        // --- GESTION DU BOUTON GÉNÉRER ---
        ui.btnGenerate.onclick = async () => {
            const btn = ui.btnGenerate;
            const originalText = btn.innerHTML;
            
            // Validation
            const source = document.querySelector('input[name="quiz-source"]:checked').value;
            let topic = "";
            
            if (source === 'topic') {
                topic = ui.topicInput.value.trim();
                if (!topic) return showMessage("Entre un sujet pour le quiz.", "error");
            } else {
                const select = ui.fileSelect;
                if (!select.value) return showMessage("Sélectionne un fichier.", "error");
                // Pour l'instant, on utilise le nom du fichier comme topic pour l'IA
                // Idéalement, on enverrait le contenu du fichier si on pouvait le lire facilement ici
                topic = select.options[select.selectedIndex].text; 
            }

            const count = ui.rangeInput.value;
            const difficulty = ui.difficultySelect.value;

            // UI Loading
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Génération IA...`;
            
            try {
                // 1. Appel API Gemini
                const questions = await generateQuiz(topic, count, difficulty);
                
                if (!questions || questions.length === 0) throw new Error("Aucune question générée.");

                // 2. Sauvegarde Firestore
                await addDoc(collection(db, 'users', currentUserId, 'quizzes'), {
                    topic: topic,
                    questions: questions,
                    createdAt: serverTimestamp(),
                    status: 'pending', // Pas encore commencé
                    difficulty: difficulty,
                    questionCount: questions.length,
                    score: null // Pas de score
                });

                // 3. Reset UI & Reload
                toggleModal(false);
                ui.topicInput.value = "";
                showMessage('Quiz généré avec succès !', 'success');
                loadQuizzes();

            } catch (error) {
                showMessage(`Erreur: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // --- HELPER FUNCTIONS ---
        async function loadUserFiles() {
            const q = query(collection(db, 'users', currentUserId, 'courses'), orderBy('createdAt', 'desc'));
            const snapshot = await getDocs(q);
            ui.fileSelect.innerHTML = '<option value="">-- Choisir un fichier --</option>';
            snapshot.forEach(doc => {
                const f = doc.data();
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.textContent = f.title || f.fileName;
                ui.fileSelect.appendChild(opt);
            });
        }

        // --- NOTIFICATIONS ---
        function setupNotifications(userId) {
            const q = query(collection(db, 'users', userId, 'notifications'), orderBy('createdAt', 'desc'), limit(5));
            onSnapshot(q, (snapshot) => {
                const notifs = snapshot.docs.map(d => d.data());
                if (notifs.length > 0) {
                    ui.notifBadge.classList.remove('hidden');
                    ui.notifList.innerHTML = notifs.map(n => `
                        <div class="p-3 border-b border-gray-800 text-left hover:bg-gray-800/50">
                            <p class="text-white text-sm">${n.message}</p>
                        </div>
                    `).join('');
                } else {
                    ui.notifBadge.classList.add('hidden');
                }
            });
        }
        ui.notifBtn.onclick = (e) => { e.stopPropagation(); ui.notifDropdown.classList.toggle('hidden'); };
        window.onclick = (e) => { if(!ui.notifDropdown.contains(e.target) && !ui.notifBtn.contains(e.target)) ui.notifDropdown.classList.add('hidden'); };

        // --- MODAL & FORM LOGIC ---
        const toggleModal = (show) => {
            if(show) ui.modal.classList.remove('hidden');
            else ui.modal.classList.add('hidden');
        };
        ui.btnOpenHero.onclick = () => toggleModal(true);
        ui.btnOpenHeader.onclick = () => toggleModal(true);
        ui.btnClose.onclick = () => toggleModal(false);
        ui.btnCancel.onclick = () => toggleModal(false);

        ui.sourceRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if(e.target.value === 'file') {
                    ui.topicContainer.classList.add('hidden');
                    ui.fileContainer.classList.remove('hidden');
                } else {
                    ui.topicContainer.classList.remove('hidden');
                    ui.fileContainer.classList.add('hidden');
                }
            });
        });

        ui.rangeInput.addEventListener('input', (e) => ui.rangeVal.textContent = e.target.value);
        async function loadUserStats() {} // Remplacé par le calcul dynamique dans loadQuizzes

    </script>
</body>
</html>