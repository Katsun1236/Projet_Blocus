<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signaler un Bug - Projet Blocus</title>
    <link rel="icon" type="image/png" href="../../assets/images/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../../assets/js/suppress-warnings.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
</head>
<body class="relative selection:bg-indigo-500 selection:text-white overflow-hidden h-screen flex flex-col items-center justify-center">
    <!-- Script pour masquer lavertissement Tailwind CDN -->
    <script>
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && args[0].includes && args[0].includes("cdn.tailwindcss.com")) {
                return; // Masquer lavertissement Tailwind
            }
            originalWarn.apply(console, args);
        };
    </script>

    <div class="noise-overlay"></div>
    <div class="glow-bg" style="top: -10%; right: -10%; background: radial-gradient(circle, rgba(239, 68, 68, 0.15) 0%, transparent 70%);"></div>

    <div class="w-full max-w-lg p-6 relative z-10">
        
        <a href="dashboard.html" class="inline-flex items-center gap-2 text-gray-400 hover:text-white mb-6 transition-colors">
            <i class="fas fa-arrow-left"></i> Retour au Dashboard
        </a>

        <div class="bg-gray-900/80 backdrop-blur-xl border border-gray-700 rounded-3xl p-8 shadow-2xl">
            
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-red-500/10 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                    <i class="fas fa-bug text-3xl text-red-400"></i>
                </div>
                <h1 class="text-2xl font-display font-bold text-white mb-2">Signaler un problème</h1>
                <p class="text-gray-400 text-sm">Aide-nous à améliorer la plateforme.</p>
            </div>

            <form id="bug-form" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Titre du problème</label>
                    <input type="text" id="bug-title" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-red-500 outline-none" placeholder="Ex: Erreur lors de l'upload..." required>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Description détaillée</label>
                    <textarea id="bug-desc" rows="4" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-red-500 outline-none resize-none" placeholder="Que s'est-il passé ? Sur quelle page ?" required></textarea>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Sévérité</label>
                    <div class="flex gap-3">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="severity" value="low" class="peer hidden" checked>
                            <div class="py-3 rounded-xl bg-gray-800 border border-gray-700 text-center text-gray-400 peer-checked:bg-green-900/30 peer-checked:border-green-500 peer-checked:text-green-400 transition-all text-sm font-bold">Mineur</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="severity" value="medium" class="peer hidden">
                            <div class="py-3 rounded-xl bg-gray-800 border border-gray-700 text-center text-gray-400 peer-checked:bg-yellow-900/30 peer-checked:border-yellow-500 peer-checked:text-yellow-400 transition-all text-sm font-bold">Gênant</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="severity" value="high" class="peer hidden">
                            <div class="py-3 rounded-xl bg-gray-800 border border-gray-700 text-center text-gray-400 peer-checked:bg-red-900/30 peer-checked:border-red-500 peer-checked:text-red-400 transition-all text-sm font-bold">Critique</div>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl shadow-lg shadow-red-900/20 transition-all flex items-center justify-center gap-2 mt-4">
                    <span>Envoyer le rapport</span>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>

        </div>
    </div>

    <div id="message-box" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <script type="module">
        import { auth, db } from '../../assets/js/config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        let currentUserId = null;
        let userEmail = "";

        function showMessage(message) {
            const box = document.createElement('div');
            box.className = "p-4 rounded-xl shadow-2xl bg-gray-900 border border-green-500/30 text-white flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-500 pointer-events-auto";
            box.innerHTML = `<i class="fas fa-check-circle text-green-400"></i> <span class="font-bold text-sm">${message}</span>`;
            document.getElementById('message-box').appendChild(box);
            requestAnimationFrame(() => box.classList.remove('translate-y-10', 'opacity-0'));
            setTimeout(() => { box.classList.add('translate-y-10', 'opacity-0'); setTimeout(() => box.remove(), 500); }, 3000);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userEmail = user.email;
            } else {
                window.location.href = '../auth/login.html';
            }
        });

        document.getElementById('bug-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;

            const btn = e.target.querySelector('button');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi...';

            try {
                await addDoc(collection(db, 'reports'), {
                    title: document.getElementById('bug-title').value,
                    description: document.getElementById('bug-desc').value,
                    severity: document.querySelector('input[name="severity"]:checked').value,
                    userId: currentUserId,
                    userEmail: userEmail,
                    status: 'open',
                    createdAt: serverTimestamp()
                });

                showMessage("Rapport envoyé ! Merci.");
                e.target.reset();
                setTimeout(() => window.location.href = 'dashboard.html', 2000);

            } catch (error) {
                console.error(error);
                alert("Erreur lors de l'envoi.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        });
    </script>
</body>
</html>