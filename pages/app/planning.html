<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning - Projet Blocus</title>
    <link rel="icon" type="image/png" href="../../assets/images/logo.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    
    <style>
        .content-glass {
            background: rgba(20, 20, 20, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        /* Style des jours du calendrier */
        .calendar-day {
            min-height: 100px;
            transition: all 0.2s;
        }
        .calendar-day:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .calendar-day.today {
            background-color: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.5);
        }
        /* Scrollbar custom pour les listes d'Ã©vÃ©nements */
        .event-list::-webkit-scrollbar { width: 4px; }
        .event-list::-webkit-scrollbar-track { background: transparent; }
        .event-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
    </style>
</head>

<body id="app-container" class="relative selection:bg-indigo-500 selection:text-white overflow-hidden h-screen flex bg-[#050505]">

    <!-- FOND ANIMÃ‰ -->
    <div class="noise-overlay"></div>
    <div class="glow-bg" style="top: -10%; left: 30%; background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 60%);"></div>
    <div class="glow-bg" style="bottom: 10%; right: 10%; background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 60%);"></div>

    <!-- MAIN CONTENT -->
    <div class="flex-grow flex flex-col min-w-0 relative z-10 md:ml-64 transition-all duration-300">
        
        <!-- HEADER -->
        <header class="h-20 border-b border-gray-800/50 flex items-center justify-between px-8 bg-gray-900/30 backdrop-blur-sm z-30 sticky top-0">
            <div class="flex items-center gap-4">
                <button id="mobile-menu-btn" class="md:hidden text-gray-400 hover:text-white"><i class="fas fa-bars text-xl"></i></button>
                <div class="hidden md:block">
                    <h1 class="text-xl font-display font-bold text-white">Mon Planning</h1>
                    <p class="text-sm text-gray-400">Organise tes rÃ©visions</p>
                </div>
                <span class="md:hidden text-white font-bold">Planning</span>
            </div>

            <div class="flex items-center gap-6">
                <!-- Bouton Ajout Rapide -->
                <button id="btn-add-event-header" class="hidden sm:flex bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg shadow-emerald-500/20 transition-all items-center gap-2">
                    <i class="fas fa-plus"></i> <span>Ajouter</span>
                </button>

                <div class="h-8 w-px bg-gray-800 hidden sm:block"></div>

                <!-- Notifications & Profil -->
                <div class="relative">
                    <button id="notif-btn" class="relative text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-white/5 outline-none">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notif-badge" class="absolute top-1.5 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-gray-900 hidden transform scale-100 transition-transform"></span>
                    </button>
                    <div id="notif-dropdown" class="hidden absolute right-0 mt-4 w-80 bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl overflow-hidden z-50">
                        <div id="notifications-list" class="max-h-[300px] overflow-y-auto p-4 text-center text-gray-500 text-sm">Aucune nouvelle notification</div>
                    </div>
                </div>
                <a href="profile.html" class="flex items-center gap-3 group cursor-pointer pl-2">
                    <div class="text-right hidden sm:block">
                        <p id="user-name-header" class="text-sm font-bold text-white group-hover:text-indigo-400 transition-colors">...</p>
                        <p class="text-xs text-gray-500">Ã‰tudiant</p>
                    </div>
                    <img id="user-avatar-header" src="" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-gray-700 group-hover:border-indigo-500 transition-colors object-cover bg-gray-800">
                </a>
            </div>
        </header>

        <!-- CONTENU SCROLLABLE -->
        <main class="flex-grow p-6 overflow-y-auto custom-scrollbar flex flex-col lg:flex-row gap-6">
            
            <!-- COLONNE GAUCHE: CALENDRIER -->
            <div class="flex-grow flex flex-col space-y-6">
                
                <!-- Controls du mois -->
                <div class="flex justify-between items-center bg-gray-900/50 p-4 rounded-2xl border border-gray-800 backdrop-blur-sm">
                    <div class="flex items-center gap-4">
                        <button id="prev-month" class="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition-colors"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="current-month-display" class="text-xl font-bold text-white capitalize w-40 text-center">Chargement...</h2>
                        <button id="next-month" class="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition-colors"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <button id="today-btn" class="text-sm text-indigo-400 hover:text-indigo-300 font-medium">Aujourd'hui</button>
                </div>

                <!-- Grille Calendrier -->
                <div class="content-glass rounded-2xl p-6 flex-grow flex flex-col">
                    <!-- Jours Semaine -->
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                        <div class="text-gray-500 text-xs font-bold uppercase py-2">Lun</div>
                        <div class="text-gray-500 text-xs font-bold uppercase py-2">Mar</div>
                        <div class="text-gray-500 text-xs font-bold uppercase py-2">Mer</div>
                        <div class="text-gray-500 text-xs font-bold uppercase py-2">Jeu</div>
                        <div class="text-gray-500 text-xs font-bold uppercase py-2">Ven</div>
                        <div class="text-gray-500 text-xs font-bold uppercase py-2 text-indigo-400">Sam</div>
                        <div class="text-gray-500 text-xs font-bold uppercase py-2 text-indigo-400">Dim</div>
                    </div>
                    
                    <!-- Jours -->
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 flex-grow auto-rows-fr">
                        <!-- GÃ©nÃ©rÃ© par JS -->
                    </div>
                </div>
            </div>

            <!-- COLONNE DROITE: AUJOURD'HUI & PROCHAINEMENT -->
            <div class="w-full lg:w-80 flex-shrink-0 space-y-6">
                
                <!-- Carte Aujourd'hui -->
                <div class="content-glass rounded-2xl p-6 border border-gray-800">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-calendar-day text-emerald-400"></i> Aujourd'hui
                    </h3>
                    <div id="today-events-list" class="space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                        <p class="text-gray-500 text-sm text-center py-4">Aucune tÃ¢che prÃ©vue.</p>
                    </div>
                    <button id="btn-add-today" class="w-full mt-4 py-2 rounded-lg bg-gray-800 text-gray-300 hover:bg-gray-700 text-sm font-medium transition-colors border border-gray-700 border-dashed hover:border-solid">
                        <i class="fas fa-plus mr-2"></i> Ajouter une tÃ¢che
                    </button>
                </div>

                <!-- Carte Examens / Deadlines -->
                <div class="content-glass rounded-2xl p-6 border border-gray-800">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-flag-checkered text-red-400"></i> Examens & Deadlines
                    </h3>
                    <div id="upcoming-exams-list" class="space-y-3 max-h-[250px] overflow-y-auto custom-scrollbar pr-1">
                        <p class="text-gray-500 text-sm text-center py-4">Rien Ã  l'horizon.</p>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <!-- MODAL AJOUT Ã‰VÃ‰NEMENT -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Nouvel Ã‰vÃ©nement</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="event-form" class="p-6 space-y-4">
                <div class="space-y-1">
                    <label class="text-sm text-gray-400">Titre</label>
                    <input type="text" id="event-title" required placeholder="Ex: RÃ©vision Math, Examen Histoire..." 
                        class="w-full bg-black/20 border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-sm text-gray-400">Date</label>
                        <input type="date" id="event-date" required 
                            class="w-full bg-black/20 border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-sm text-gray-400">Type</label>
                        <select id="event-type" class="w-full bg-black/20 border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none">
                            <option value="revision">RÃ©vision ðŸ“š</option>
                            <option value="exam">Examen ðŸš©</option>
                            <option value="course">Cours ðŸŽ“</option>
                            <option value="other">Autre ðŸ“Œ</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-sm text-gray-400">DÃ©but</label>
                        <input type="time" id="event-start" class="w-full bg-black/20 border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-sm text-gray-400">Fin</label>
                        <input type="time" id="event-end" class="w-full bg-black/20 border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-event-btn" class="px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">Annuler</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-emerald-600 text-white font-bold hover:bg-emerald-500 transition-colors">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed top-4 right-4 z-50"></div>

    <script type="module">
        import { auth, db } from '../../assets/js/config.js';
        import { initLayout } from '../../assets/js/layout.js';
        import { showMessage, formatDate } from '../../assets/js/utils.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { collection, query, where, getDocs, addDoc, orderBy, deleteDoc, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --- STATE ---
        let currentUserId = null;
        let currentDate = new Date(); // Date affichÃ©e dans le calendrier
        let eventsCache = []; // Stockage local des Ã©vÃ©nements du mois

        // --- DOM ---
        const ui = {
            calendarGrid: document.getElementById('calendar-grid'),
            monthDisplay: document.getElementById('current-month-display'),
            prevMonthBtn: document.getElementById('prev-month'),
            nextMonthBtn: document.getElementById('next-month'),
            todayBtn: document.getElementById('today-btn'),
            todayList: document.getElementById('today-events-list'),
            examList: document.getElementById('upcoming-exams-list'),
            // Modal
            modal: document.getElementById('event-modal'),
            form: document.getElementById('event-form'),
            btnCloseModal: document.getElementById('close-modal-btn'),
            btnCancel: document.getElementById('cancel-event-btn'),
            btnAddHeader: document.getElementById('btn-add-event-header'),
            btnAddToday: document.getElementById('btn-add-today'),
            // Inputs
            inputTitle: document.getElementById('event-title'),
            inputDate: document.getElementById('event-date'),
            inputType: document.getElementById('event-type'),
            inputStart: document.getElementById('event-start'),
            inputEnd: document.getElementById('event-end'),
            // Header User
            userName: document.getElementById('user-name-header'),
            userAvatar: document.getElementById('user-avatar-header'),
            // Notifs
            notifBtn: document.getElementById('notif-btn'),
            notifBadge: document.getElementById('notif-badge'),
            notifDropdown: document.getElementById('notif-dropdown'),
            notifList: document.getElementById('notifications-list')
        };

        document.addEventListener('DOMContentLoaded', () => {
            initLayout('planning');
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    await initPage();
                    loadEvents(); // Charge tout et rend le calendrier
                    setupNotifications(currentUserId);
                } else {
                    window.location.href = '../auth/login.html';
                }
            });
        });

        async function initPage() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUserId));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    ui.userName.textContent = data.firstName || "Ã‰tudiant";
                    ui.userAvatar.src = data.photoURL || 'https://ui-avatars.com/api/?background=random';
                }
            } catch(e) {}
        }

        // --- GESTION CALENDRIER ---
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); // 0-11

            // Mise Ã  jour du titre
            const monthName = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(currentDate);
            ui.monthDisplay.textContent = monthName;

            // Calculs des jours
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 (Dim) - 6 (Sam)
            // Ajustement pour Lundi=0
            const startOffset = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1; 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            ui.calendarGrid.innerHTML = '';

            // Jours du mois prÃ©cÃ©dent
            for (let i = 0; i < startOffset; i++) {
                const day = daysInPrevMonth - startOffset + 1 + i;
                const cell = createDayCell(day, 'text-gray-700 opacity-50 pointer-events-none', null);
                ui.calendarGrid.appendChild(cell);
            }

            // Jours du mois actuel
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                
                // Filtrer les Ã©vÃ©nements pour ce jour
                const dayEvents = eventsCache.filter(e => e.date === dateStr);

                const cell = createDayCell(day, isToday ? 'today text-white' : 'text-gray-300', dateStr, dayEvents);
                ui.calendarGrid.appendChild(cell);
            }

            // Jours du mois suivant (pour remplir la grille si besoin, optionnel)
            const remainingCells = 42 - (startOffset + daysInMonth); // 6 lignes * 7
            for (let i = 1; i <= remainingCells; i++) {
                const cell = createDayCell(i, 'text-gray-700 opacity-50 pointer-events-none', null);
                ui.calendarGrid.appendChild(cell);
            }
        }

        function createDayCell(dayNumber, classes, dateStr, events = []) {
            const div = document.createElement('div');
            div.className = `calendar-day rounded-xl p-2 border border-transparent flex flex-col gap-1 cursor-pointer ${classes}`;
            
            div.innerHTML = `<span class="text-sm font-bold block mb-1">${dayNumber}</span>`;
            
            // Events dots/bars
            if (events && events.length > 0) {
                const limit = 3;
                events.slice(0, limit).forEach(ev => {
                    const el = document.createElement('div');
                    let bg = 'bg-gray-700';
                    if(ev.type === 'exam') bg = 'bg-red-500/20 text-red-400 border border-red-500/30';
                    else if(ev.type === 'revision') bg = 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30';
                    else if(ev.type === 'course') bg = 'bg-blue-500/20 text-blue-400 border border-blue-500/30';

                    el.className = `text-[10px] px-1.5 py-0.5 rounded truncate ${bg}`;
                    el.textContent = ev.title;
                    div.appendChild(el);
                });
                if(events.length > limit) {
                    const more = document.createElement('div');
                    more.className = 'text-[10px] text-gray-500 pl-1';
                    more.textContent = `+ ${events.length - limit} autres`;
                    div.appendChild(more);
                }
            }

            if (dateStr) {
                div.onclick = () => openModal(dateStr);
            }

            return div;
        }

        // --- CHARGEMENT Ã‰VÃ‰NEMENTS ---
        async function loadEvents() {
            // On charge TOUS les Ã©vÃ©nements pour simplifier (ou optimiser par range de date si bcp de data)
            const q = query(collection(db, 'users', currentUserId, 'planning'), orderBy('date'), orderBy('startTime'));
            
            // Ã‰coute temps rÃ©el
            onSnapshot(q, (snapshot) => {
                eventsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCalendar();
                updateSidebars();
            });
        }

        function updateSidebars() {
            const todayStr = new Date().toISOString().split('T')[0];
            
            // 1. Aujourd'hui
            const todayEvents = eventsCache.filter(e => e.date === todayStr);
            ui.todayList.innerHTML = '';
            
            if(todayEvents.length === 0) {
                ui.todayList.innerHTML = `<p class="text-gray-500 text-sm text-center py-4">Rien de prÃ©vu aujourd'hui. Repos ? ðŸ˜´</p>`;
            } else {
                todayEvents.forEach(ev => {
                    const el = createSideEventCard(ev);
                    ui.todayList.appendChild(el);
                });
            }

            // 2. Examens & Deadlines (Futur)
            const upcomingExams = eventsCache
                .filter(e => e.type === 'exam' && e.date >= todayStr)
                .sort((a,b) => a.date.localeCompare(b.date))
                .slice(0, 5); // Max 5

            ui.examList.innerHTML = '';
            if(upcomingExams.length === 0) {
                ui.examList.innerHTML = `<p class="text-gray-500 text-sm text-center py-4">Aucun examen en vue. ðŸŽ‰</p>`;
            } else {
                upcomingExams.forEach(ev => {
                    const el = createSideEventCard(ev, true);
                    ui.examList.appendChild(el);
                });
            }
        }

        function createSideEventCard(ev, showDate = false) {
            const div = document.createElement('div');
            let border = 'border-l-4 border-gray-600';
            if(ev.type === 'exam') border = 'border-l-4 border-red-500 bg-red-500/5';
            else if(ev.type === 'revision') border = 'border-l-4 border-emerald-500 bg-emerald-500/5';
            else if(ev.type === 'course') border = 'border-l-4 border-blue-500 bg-blue-500/5';

            const timeDisplay = ev.startTime ? `${ev.startTime} - ${ev.endTime || '...'}` : 'Toute la journÃ©e';
            const dateDisplay = showDate ? `<span class="text-xs font-bold block mb-0.5 text-white">${new Date(ev.date).toLocaleDateString('fr-FR', {day:'numeric', month:'short'})}</span>` : '';

            div.className = `p-3 rounded-r-lg bg-gray-800/50 hover:bg-gray-800 transition-colors cursor-pointer group relative ${border}`;
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        ${dateDisplay}
                        <h4 class="text-sm font-bold text-gray-200">${ev.title}</h4>
                        <p class="text-xs text-gray-500 mt-0.5"><i class="far fa-clock text-[10px] mr-1"></i> ${timeDisplay}</p>
                    </div>
                    <button class="delete-event-btn text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1" data-id="${ev.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            // Delete action
            div.querySelector('.delete-event-btn').addEventListener('click', async (e) => {
                e.stopPropagation();
                if(confirm("Supprimer cet Ã©vÃ©nement ?")) {
                    await deleteDoc(doc(db, 'users', currentUserId, 'planning', ev.id));
                    showMessage('SupprimÃ©', 'success');
                }
            });

            return div;
        }

        // --- NAVIGATION MOIS ---
        ui.prevMonthBtn.onclick = () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        };
        ui.nextMonthBtn.onclick = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        };
        ui.todayBtn.onclick = () => {
            currentDate = new Date();
            renderCalendar();
        };

        // --- MODAL & FORM ---
        function openModal(dateStr = null) {
            ui.modal.classList.remove('hidden');
            if (dateStr) {
                ui.inputDate.value = dateStr;
            } else {
                ui.inputDate.valueAsDate = new Date();
            }
            ui.inputTitle.focus();
        }

        function closeModal() {
            ui.modal.classList.add('hidden');
            ui.form.reset();
        }

        ui.btnAddHeader.onclick = () => openModal();
        ui.btnAddToday.onclick = () => openModal(new Date().toISOString().split('T')[0]);
        ui.btnCloseModal.onclick = closeModal;
        ui.btnCancel.onclick = closeModal;

        ui.form.onsubmit = async (e) => {
            e.preventDefault();
            
            const eventData = {
                title: ui.inputTitle.value.trim(),
                date: ui.inputDate.value,
                type: ui.inputType.value,
                startTime: ui.inputStart.value || null,
                endTime: ui.inputEnd.value || null,
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, 'users', currentUserId, 'planning'), eventData);
                closeModal();
                showMessage('Ã‰vÃ©nement ajoutÃ© !', 'success');
            } catch (error) {
                console.error(error);
                showMessage('Erreur lors de l\'ajout', 'error');
            }
        };

        // --- NOTIFS ---
        function setupNotifications(userId) {
            const q = query(collection(db, 'users', userId, 'notifications'), orderBy('createdAt', 'desc'), limit(5));
            onSnapshot(q, (snapshot) => {
                const notifs = snapshot.docs.map(d => d.data());
                if (notifs.length > 0) {
                    ui.notifBadge.classList.remove('hidden');
                    ui.notifList.innerHTML = notifs.map(n => `<div class="p-3 border-b border-gray-800 text-left text-sm text-gray-300">${n.message}</div>`).join('');
                } else {
                    ui.notifBadge.classList.add('hidden');
                }
            });
        }
        ui.notifBtn.onclick = (e) => { e.stopPropagation(); ui.notifDropdown.classList.toggle('hidden'); };
        window.onclick = (e) => { if(!ui.notifDropdown.contains(e.target) && !ui.notifBtn.contains(e.target)) ui.notifDropdown.classList.add('hidden'); };

    </script>
</body>
</html>