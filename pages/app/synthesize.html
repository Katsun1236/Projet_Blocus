<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Synth√®ses - Projet Blocus</title>
    <link rel="icon" type="image/png" href="../../assets/images/logo.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js & jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    
    <style>
        .sidebar-glass {
            background: rgba(5, 5, 5, 0.6);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        .content-glass {
            background: rgba(20, 20, 20, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .nav-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: #fff;
            border-left: 3px solid #6366f1;
        }
        .nav-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.03);
            color: #e5e7eb;
        }
        /* Styles sp√©cifiques Synth√®se */
        .synthesis-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .synthesis-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(99, 102, 241, 0.3);
        }
        /* Typography pour le contenu g√©n√©r√© */
        .prose h2 { font-size: 1.25rem; font-weight: 700; color: #fff; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; color: #d1d5db; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; color: #d1d5db; }
        .prose li { margin-bottom: 0.5em; }
        .prose strong { color: #818cf8; font-weight: 600; }
    </style>
</head>
<body class="relative selection:bg-indigo-500 selection:text-white overflow-hidden h-screen flex">

    <!-- FOND ANIM√â -->
    <div class="noise-overlay"></div>
    <div class="glow-bg" style="top: -20%; left: 30%; background: radial-gradient(circle, rgba(99,102,241,0.1) 0%, transparent 70%);"></div>
    <div class="glow-bg" style="bottom: -10%; right: -10%; background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);"></div>

    <!-- SIDEBAR -->
    <aside class="w-72 sidebar-glass flex-shrink-0 hidden md:flex flex-col z-20 relative">
        <div class="p-6 flex items-center gap-3 mb-6">
            <div class="w-8 h-8 bg-white text-black rounded-lg flex items-center justify-center font-bold text-lg tracking-tighter">
                B.
            </div>
            <span class="font-display font-bold text-lg tracking-wide text-white">Projet Blocus</span>
        </div>

        <nav class="flex-grow px-4 space-y-2">
            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Menu Principal</p>
            <a href="dashboard.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-th-large w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Tableau de Bord</span>
            </a>
            <a href="courses.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-book w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Mes Cours</span>
            </a>
            <a href="quiz.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-brain w-6 group-hover:text-purple-400 transition-colors"></i>
                <span class="font-medium">Quiz IA</span>
            </a>
            <a href="planning.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-calendar-alt w-6 group-hover:text-emerald-400 transition-colors"></i>
                <span class="font-medium">Planning</span>
            </a>

            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mt-8 mb-2">Outils</p>
            <a href="#" class="nav-item active flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-magic w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Synth√©tiseur</span>
            </a>
            
            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mt-8 mb-2">Social</p>
            <a href="friends.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-user-friends w-6 group-hover:text-pink-400 transition-colors"></i>
                <span class="font-medium">Mes Amis</span>
            </a>
            <a href="chat.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-paper-plane w-6 group-hover:text-blue-400 transition-colors"></i>
                <span class="font-medium">Discussions</span>
            </a>
            <a href="community.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-users w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Communaut√©</span>
            </a>
            <a href="forum.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-comments w-6 group-hover:text-purple-400 transition-colors"></i>
                <span class="font-medium">Forum</span>
            </a>

            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mt-8 mb-2">Personnel</p>
            <a href="profile.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-user-circle w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Mon Profil</span>
            </a>
        </nav>

        <div class="p-4 border-t border-gray-800">
            <button id="logout-button" class="w-full flex items-center px-4 py-3 rounded-lg text-red-400 hover:bg-red-500/10 transition-colors group">
                <i class="fas fa-sign-out-alt w-6 group-hover:text-red-500 transition-colors"></i>
                <span class="font-medium">D√©connexion</span>
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="flex-grow flex flex-col min-w-0 relative z-10">
        
        <!-- Header Mobile -->
        <header class="h-16 md:hidden border-b border-gray-800/50 flex items-center justify-between px-6 bg-gray-900/30 backdrop-blur-sm">
            <div class="flex items-center gap-4">
                <button class="text-gray-400 hover:text-white"><i class="fas fa-bars text-xl"></i></button>
                <span class="font-bold text-lg text-white">Synth√®ses</span>
            </div>
        </header>

        <main class="flex-grow p-6 md:p-10 overflow-y-auto">
            
            <!-- SECTION: LISTE DES SYNTH√àSES -->
            <section id="synthesis-list-section" class="max-w-5xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-10 gap-4">
                    <div>
                        <h1 class="text-3xl font-display font-bold text-white mb-2">Mes Synth√®ses</h1>
                        <p class="text-gray-400">Retrouve tous tes r√©sum√©s g√©n√©r√©s par IA.</p>
                    </div>
                    <button id="go-to-generator-btn" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-900/40 transition-all flex items-center gap-2 transform hover:scale-105">
                        <i class="fas fa-plus"></i>
                        <span>Nouvelle Synth√®se</span>
                    </button>
                </div>

                <div id="loading-syntheses" class="flex justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
                </div>

                <div id="no-syntheses" class="hidden text-center py-20 content-glass rounded-3xl border border-dashed border-gray-700">
                    <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-gray-600">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">C'est vide ici !</h3>
                    <p class="text-gray-400 mb-6">G√©n√®re ta premi√®re synth√®se pour commencer √† r√©viser.</p>
                    <button onclick="document.getElementById('go-to-generator-btn').click()" class="text-indigo-400 hover:text-indigo-300 font-medium">Cr√©er une synth√®se maintenant</button>
                </div>

                <div id="saved-syntheses-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Les cartes seront inject√©es ici par JS -->
                </div>
            </section>

            <!-- SECTION: SETUP / FORMULAIRE -->
            <section id="synthesis-setup-section" class="hidden max-w-3xl mx-auto">
                <button id="back-to-list-btn-setup" class="text-gray-400 hover:text-white mb-6 flex items-center gap-2 transition-colors">
                    <i class="fas fa-arrow-left"></i> Retour
                </button>

                <div class="content-glass rounded-3xl p-8 md:p-10 border border-gray-800 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-purple-600/10 rounded-full blur-3xl -mr-16 -mt-16"></div>
                    
                    <div class="text-center mb-10 relative z-10">
                        <div class="w-16 h-16 bg-indigo-500/10 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-indigo-500/20">
                            <i class="fas fa-magic text-3xl text-indigo-400"></i>
                        </div>
                        <h2 class="text-3xl font-display font-bold text-white mb-2">G√©n√©rateur IA</h2>
                        <p class="text-gray-400">S√©lectionne tes sources et laisse la magie op√©rer.</p>
                    </div>

                    <form id="synthesis-generator-form" class="space-y-8 relative z-10">
                        
                        <!-- Titre -->
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2 uppercase tracking-wider">1. Titre de la synth√®se</label>
                            <input type="text" id="synthesis-title-input" class="w-full px-5 py-4 bg-gray-800/50 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all placeholder-gray-600" placeholder="Ex: Psychologie Cognitive - Chapitre 1" required>
                        </div>

                        <!-- S√©lection Cours -->
                        <div>
                            <label class="block text-sm font-bold text-gray-300 mb-2 uppercase tracking-wider">2. Sources (Cours)</label>
                            <div class="relative">
                                <select id="course-select" multiple class="w-full p-4 bg-gray-800/50 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all h-40 custom-select" required>
                                    <!-- Options inject√©es par JS -->
                                </select>
                                <p class="text-xs text-gray-500 mt-2 text-right">Maintiens Ctrl/Cmd pour s√©lectionner plusieurs fichiers</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Longueur -->
                            <div>
                                <label class="block text-sm font-bold text-gray-300 mb-2 uppercase tracking-wider">3. Longueur</label>
                                <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4">
                                    <div class="flex justify-between mb-2">
                                        <span class="text-gray-400 text-xs">Court</span>
                                        <span id="word-count-value" class="text-indigo-400 font-bold">500 mots</span>
                                        <span class="text-gray-400 text-xs">Long</span>
                                    </div>
                                    <input type="range" id="word-count" min="100" max="2000" value="500" step="100" class="w-full accent-indigo-500">
                                </div>
                            </div>

                            <!-- Style -->
                            <div>
                                <label class="block text-sm font-bold text-gray-300 mb-2 uppercase tracking-wider">4. Format</label>
                                <div class="relative">
                                    <select id="synthesis-style" class="w-full px-5 py-4 bg-gray-800/50 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none appearance-none cursor-pointer">
                                        <option value="R√©sum√© Standard">üìÑ R√©sum√© Standard</option>
                                        <option value="Points Cl√©s (Puces)">üìù Points Cl√©s (Listes)</option>
                                        <option value="Fiche de R√©vision (Q&A)">‚ùì Questions / R√©ponses</option>
                                        <option value="Explication Simplifi√©e (ELI5)">üë∂ Explique-moi comme si j'avais 5 ans</option>
                                        <option value="Plan D√©taill√©">üóÇÔ∏è Plan Structur√©</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-400">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold text-lg rounded-xl shadow-lg shadow-indigo-900/30 transition-all transform hover:scale-[1.01] flex items-center justify-center gap-3">
                            <i class="fas fa-magic"></i>
                            <span>G√©n√©rer la synth√®se</span>
                        </button>
                    </form>
                </div>
            </section>

            <!-- SECTION: LOADING -->
            <section id="synthesis-loading-section" class="hidden flex flex-col items-center justify-center py-32 text-center">
                <div class="relative w-24 h-24 mb-8">
                    <div class="absolute inset-0 rounded-full border-4 border-gray-800"></div>
                    <div class="absolute inset-0 rounded-full border-4 border-indigo-500 border-t-transparent animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-2xl animate-pulse">‚ú®</div>
                </div>
                <h2 class="text-3xl font-display font-bold text-white mb-2">Analyse en cours...</h2>
                <p class="text-gray-400 max-w-md">L'IA lit vos documents, extrait les concepts cl√©s et r√©dige votre synth√®se. Cela peut prendre quelques secondes.</p>
            </section>

            <!-- SECTION: RESULTAT -->
            <section id="synthesis-result-section" class="hidden max-w-4xl mx-auto">
                <button id="back-to-list-btn-result" class="text-gray-400 hover:text-white mb-6 flex items-center gap-2 transition-colors">
                    <i class="fas fa-arrow-left"></i> Retour
                </button>

                <div class="content-glass rounded-3xl overflow-hidden border border-gray-800 shadow-2xl">
                    <!-- Header Resultat -->
                    <div class="bg-gray-900/50 border-b border-gray-800 p-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <span class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-1 block">Synth√®se G√©n√©r√©e</span>
                            <h1 id="synthesis-result-title" class="text-2xl md:text-3xl font-display font-bold text-white">Titre du Document</h1>
                        </div>
                        <div class="flex gap-3">
                            <button id="copy-synthesis-btn" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg text-sm font-bold transition-colors flex items-center gap-2">
                                <i class="fas fa-copy"></i> Copier
                            </button>
                            <button id="download-pdf-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-bold transition-colors flex items-center gap-2 shadow-lg shadow-indigo-900/20">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>

                    <!-- Contenu Resultat -->
                    <div class="p-8 md:p-12 bg-gray-900/30">
                        <div id="synthesis-result-content" class="prose prose-invert max-w-none">
                            <!-- Contenu inject√© ici -->
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>
    
    <!-- Message Box -->
    <div id="message-box" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- JAVASCRIPT -->
    <script type="module">
        import { auth, db, app } from '../../assets/js/config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { doc, getDoc, collection, getDocs, addDoc, serverTimestamp, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        // Importation des fonctions Firebase
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";


        let userCourses = [];
        // Initialisation de Firebase Functions
        const functions = getFunctions(app);
        const generateSynthesisCloud = httpsCallable(functions, 'generateSynthesis');


        const ui = {
            list: document.getElementById('synthesis-list-section'),
            setup: document.getElementById('synthesis-setup-section'),
            loading: document.getElementById('synthesis-loading-section'),
            result: document.getElementById('synthesis-result-section'),
            form: document.getElementById('synthesis-generator-form'),
            courseSelect: document.getElementById('course-select'),
            wordCount: document.getElementById('word-count'),
            wordCountValue: document.getElementById('word-count-value'),
            resultTitle: document.getElementById('synthesis-result-title'),
            resultContent: document.getElementById('synthesis-result-content'),
            copyBtn: document.getElementById('copy-synthesis-btn'),
            downloadPdfBtn: document.getElementById('download-pdf-btn'),
            goToGeneratorBtn: document.getElementById('go-to-generator-btn'),
            backToListBtnSetup: document.getElementById('back-to-list-btn-setup'),
            backToListBtnResult: document.getElementById('back-to-list-btn-result'),
            savedSynthesesList: document.getElementById('saved-syntheses-list'),
            loadingSyntheses: document.getElementById('loading-syntheses'),
            noSyntheses: document.getElementById('no-syntheses'),
            navLoggedIn: document.getElementById('nav-logged-in'),
            logoutButton: document.getElementById('logout-button'),
        };

        function showMessage(message, isError = false) {
            const box = document.createElement('div');
            box.className = `p-4 rounded-xl shadow-2xl text-white flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-500 pointer-events-auto border ${isError ? 'bg-gray-900 border-red-500/30' : 'bg-gray-900 border-green-500/30'}`;
            box.innerHTML = `
                <div class="${isError ? 'text-red-400' : 'text-green-400'} text-xl"><i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i></div>
                <p class="font-medium text-sm">${message}</p>
            `;
            document.getElementById('message-box').appendChild(box);
            
            requestAnimationFrame(() => { box.classList.remove('translate-y-10', 'opacity-0'); });
            setTimeout(() => { 
                box.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => box.remove(), 500);
            }, 4000);
        }

        function showSection(section) {
            ['list', 'setup', 'loading', 'result'].forEach(s => ui[s].classList.add('hidden'));
            ui[section].classList.remove('hidden');
        }

        async function populateCourses() {
            if(!auth.currentUser) return;
            const coursesRef = collection(db, 'users', auth.currentUser.uid, 'courses');
            
            try {
                const coursesSnap = await getDocs(coursesRef);
                userCourses = coursesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                ui.courseSelect.innerHTML = '';
                if (userCourses.length === 0) {
                    ui.courseSelect.innerHTML = '<option value="" disabled>Aucun cours disponible. Uploadez un PDF d\'abord.</option>';
                } else {
                    userCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.title || course.name || course.fileName;
                        ui.courseSelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.error("Erreur de chargement des cours:", e);
                showMessage("Erreur de chargement des cours.", true);
            }
        }

        async function extractTextFromPdf(url) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
            
            // NOTE: La lecture du PDF √©choue si les r√®gles CORS de Firebase Storage sont incorrectes.
            // L'erreur "ERR_FAILED" est souvent caus√©e par le blocage du CORS.
            // La solution est d'appliquer les r√®gles CORS via gsutil sur votre bucket.

            const pdf = await pdfjsLib.getDocument(url).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            return fullText;
        }

        async function generateSynthesis(e) {
            e.preventDefault();
            const selectedOptions = [...ui.courseSelect.selectedOptions];
            if (selectedOptions.length === 0 || selectedOptions[0].disabled) {
                showMessage('Veuillez s√©lectionner au moins un cours.', true);
                return;
            }
            showSection('loading');

            try {
                let combinedText = '';
                for (const option of selectedOptions) {
                    const course = userCourses.find(c => c.id === option.value);
                    if (course && (course.url || course.fileURL)) { 
                        const url = course.url || course.fileURL;
                        
                        // Tentative de lecture du PDF via PDF.js. C'est ici que l'erreur CORS se produit.
                        // Si le CORS est r√©solu, cela fonctionne :
                        combinedText += `--- Contenu du cours: ${course.title || course.name} ---\n${await extractTextFromPdf(url)}\n\n`;
                    }
                }

                const wordCount = ui.wordCount.value;
                const style = document.getElementById('synthesis-style').value;
                
                const prompt = `√Ä partir du texte suivant:\n\n${combinedText.substring(0, 30000)}\n\n---\n\nR√©dige une synth√®se de style "${style}" d'environ ${wordCount} mots. La synth√®se doit √™tre claire, bien structur√©e et au format HTML simple (utilise des balises <p>, <ul>, <li>, <h2>, <strong>). Ne mets pas de balises <html> ou <body>.`;

                // Appel √† la Cloud Function
                const result = await generateSynthesisCloud({ prompt: prompt });
                
                if (!result.data || !result.data.content) {
                    throw new Error("R√©ponse de la Cloud Function invalide ou vide.");
                }

                let synthesisHtml = result.data.content;
                synthesisHtml = synthesisHtml.replace(/```html/g, '').replace(/```/g, '').trim();

                const title = document.getElementById('synthesis-title-input').value;

                await addDoc(collection(db, 'users', auth.currentUser.uid, 'syntheses'), {
                    title: title,
                    content: synthesisHtml,
                    style: style,
                    createdAt: serverTimestamp()
                });

                showMessage('Synth√®se g√©n√©r√©e et sauvegard√©e !');
                displaySynthesis(title, synthesisHtml);

            } catch (error) {
                console.error("Erreur de g√©n√©ration/Cloud Function:", error);
                
                let displayMsg = "Erreur lors de la g√©n√©ration. ";
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                     displayMsg = "Erreur de connexion (CORS). V√©rifiez si les r√®gles CORS de Firebase Storage et la Cloud Function sont d√©ploy√©es.";
                } else if (error.message.includes('PDF')) {
                     displayMsg = "Erreur de lecture du PDF (le fichier est peut-√™tre inaccessible).";
                } else {
                    displayMsg += `D√©tails: ${error.message}`;
                }
                
                showMessage(displayMsg, true);
                showSection('setup');
            }
        }

        function displaySynthesis(title, content) {
            ui.resultTitle.textContent = title;
            ui.resultContent.innerHTML = content;
            showSection('result');
        }

        function renderSavedSyntheses(syntheses) {
            ui.loadingSyntheses.classList.add('hidden');
            ui.savedSynthesesList.innerHTML = '';

            if (syntheses.length === 0) {
                ui.noSyntheses.classList.remove('hidden');
            } else {
                ui.noSyntheses.classList.add('hidden');
                syntheses.forEach(synth => {
                    const el = document.createElement('div');
                    el.className = 'content-glass p-5 rounded-xl flex justify-between items-center group hover:bg-gray-800/50 transition-all border border-gray-800';
                    const creationDate = synth.createdAt ? new Date(synth.createdAt.seconds * 1000).toLocaleDateString('fr-FR') : 'R√©cemment';
                    
                    el.innerHTML = `
                        <div class="flex items-center gap-4 overflow-hidden">
                            <div class="w-12 h-12 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-400 text-xl flex-shrink-0">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="truncate">
                                <h3 class="font-bold text-white truncate group-hover:text-indigo-300 transition-colors">${synth.title}</h3>
                                <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                    <span>${creationDate}</span>
                                    <span class="w-1 h-1 rounded-full bg-gray-700"></span>
                                    <span>${synth.style || 'Standard'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="view-btn p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition-colors" title="Voir"><i class="fas fa-eye"></i></button>
                            <button class="delete-btn p-2 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors" data-id="${synth.id}" title="Supprimer"><i class="fas fa-trash"></i></button>
                        </div>`;
                    
                    el.querySelector('.view-btn').addEventListener('click', () => displaySynthesis(synth.title, synth.content));
                    el.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteSynthesis(synth.id);
                    });
                    
                    ui.savedSynthesesList.appendChild(el);
                });
            }
        }

        async function deleteSynthesis(id) {
            if (confirm("Supprimer d√©finitivement cette synth√®se ?")) {
                try {
                    await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'syntheses', id));
                    showMessage('Synth√®se supprim√©e.');
                } catch (e) {
                    console.error(e);
                    showMessage('Erreur lors de la suppression.', true);
                }
            }
        }

        function copyToClipboard() {
            const textToCopy = ui.resultContent.innerText;
            // Utilisation de document.execCommand('copy') car navigator.clipboard.writeText() est parfois bloqu√© dans les iframes
            if (document.execCommand('copy')) {
                showMessage('Contenu copi√© !');
            } else {
                showMessage('Erreur copie (copie manuelle n√©cessaire).', true);
            }
        }

        function downloadAsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const title = ui.resultTitle.textContent;
            const text = ui.resultContent.innerText;
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text(title, 15, 20);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            
            const splitText = doc.splitTextToSize(text, 180);
            doc.text(splitText, 15, 40);
            
            doc.save(`${title}.pdf`);
            showMessage('PDF t√©l√©charg√© !');
        }

        // Event Listeners
        ui.wordCount.addEventListener('input', (e) => { ui.wordCountValue.textContent = `${e.target.value} mots`; });
        ui.form.addEventListener('submit', generateSynthesis);
        ui.copyBtn.addEventListener('click', copyToClipboard);
        ui.downloadPdfBtn.addEventListener('click', downloadAsPdf);
        ui.goToGeneratorBtn.addEventListener('click', () => showSection('setup'));
        ui.backToListBtnSetup.addEventListener('click', () => showSection('list'));
        ui.backToListBtnResult.addEventListener('click', () => showSection('list'));
        document.getElementById('logout-button').addEventListener('click', async () => { await signOut(auth); window.location.href = '../../index.html'; });

        // Auth State & Init
        onAuthStateChanged(auth, async (user) => {
            if (user && !user.isAnonymous) {
                populateCourses();
                const synthesesRef = collection(db, 'users', user.uid, 'syntheses');
                onSnapshot(synthesesRef, (snapshot) => {
                    const syntheses = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    renderSavedSyntheses(syntheses);
                });
            } else {
                window.location.href = '../auth/login.html';
            }
        });
    </script>
</body>
</html>