<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation - Projet Blocus</title>
    <link rel="icon" type="image/png" href="../../assets/images/locus-neon-favicon.png">
    
    
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/animations.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    
    <style>
        .sidebar-glass {
            background: rgba(5, 5, 5, 0.6);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        .content-glass {
            background: rgba(20, 20, 20, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        /* Chat Bubbles */
        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            word-wrap: break-word; /* Important pour les longs messages */
        }
        .message-sent {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border-bottom-right-radius: 4px;
            margin-left: auto;
        }
        .message-received {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            color: #e5e7eb;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom Scrollbar for Chat */
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        #chat-messages::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="relative selection:bg-indigo-500 selection:text-white overflow-hidden h-screen flex bg-[#050505]">

    
    <div class="noise-overlay"></div>
    <div class="glow-bg" style="top: -20%; left: 30%; background: radial-gradient(circle, rgba(99,102,241,0.1) 0%, transparent 70%);"></div>
    <div class="glow-bg" style="bottom: -10%; right: -10%; background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);"></div>

    
    <aside class="w-72 sidebar-glass flex-shrink-0 hidden lg:flex flex-col z-20 relative">
        <div class="p-6 flex items-center gap-3 mb-6">
            <div class="w-8 h-8 bg-white text-black rounded-lg flex items-center justify-center font-bold text-lg tracking-tighter">
                B.
            </div>
            <span class="font-display font-bold text-lg tracking-wide text-white">Projet Blocus</span>
        </div>

        <nav class="flex-grow px-4 space-y-2">
            
            <a href="chat-list.html" class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-white/5 transition-all mb-6 group">
                <i class="fas fa-arrow-left w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Retour aux Chats</span>
            </a>
            
            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Menu Principal</p>
            <a href="dashboard.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-th-large w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Tableau de Bord</span>
            </a>
            <a href="courses.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-book w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Mes Cours</span>
            </a>
            <a href="quiz.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-brain w-6 group-hover:text-purple-400 transition-colors"></i>
                <span class="font-medium">Quiz IA</span>
            </a>
            <a href="planning.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-calendar-alt w-6 group-hover:text-emerald-400 transition-colors"></i>
                <span class="font-medium">Planning</span>
            </a>
            
            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mt-8 mb-2">Outils</p>
            <a href="synthesize.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-magic w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Synthétiseur</span>
            </a>
            
            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mt-8 mb-2">Communauté</p>
            <a href="friends.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-user-friends w-6 group-hover:text-pink-400 transition-colors"></i>
                <span class="font-medium">Mes Amis</span>
            </a>
            
            <a href="chat-list.html" class="nav-item active flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-paper-plane w-6 group-hover:text-blue-400 transition-colors"></i>
                <span class="font-medium">Discussions</span>
            </a>
            <a href="community.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-globe w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Communauté</span>
            </a>
            <a href="forum.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-comments w-6 group-hover:text-pink-400 transition-colors"></i>
                <span class="font-medium">Forum</span>
            </a>
            
            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mt-8 mb-2">Personnel</p>
            <a href="profile.html" class="nav-item flex items-center px-4 py-3 rounded-lg text-gray-400 transition-all duration-200 group">
                <i class="fas fa-user-circle w-6 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Mon Profil</span>
            </a>
        </nav>
    </aside>

    
    <div class="flex-grow flex flex-col min-w-0 relative z-10 h-full">
        
        
        <header class="h-20 border-b border-gray-800/50 flex items-center justify-between px-6 bg-gray-900/50 backdrop-blur-md z-20">
            <div class="flex items-center gap-4">
                
                <a href="chat-list.html" class="lg:hidden text-gray-400 hover:text-white"><i class="fas fa-arrow-left text-xl"></i></a>
                
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <img id="recipient-avatar" src="https://ui-avatars.com/api/?background=random" class="w-10 h-10 rounded-full object-cover border-2 border-gray-700 bg-gray-800">
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-gray-900 rounded-full" title="En ligne"></span>
                    </div>
                    <div>
                        <h1 id="recipient-name" class="font-bold text-white leading-tight">Chargement...</h1>
                        <p class="text-xs text-gray-400">En ligne</p>
                    </div>
                </div>
            </div>
            
            <button class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-white/5 transition-colors">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </header>

        
        <main id="chat-messages" class="flex-grow p-6 overflow-y-auto space-y-4 flex flex-col custom-scrollbar">
            
            <div class="flex-grow min-h-[1px]"></div> 
        </main>

        
        <footer class="p-4 md:p-6 bg-gray-900/50 backdrop-blur-md border-t border-gray-800 z-20">
            <form id="message-form" class="max-w-4xl mx-auto relative flex items-end gap-3">
                
                
                <button type="button" id="attachment-btn" class="p-3 text-gray-400 hover:text-indigo-400 bg-gray-800 hover:bg-gray-700 rounded-xl transition-all flex-shrink-0" title="Envoyer fichier / Partager contenu">
                    <i class="fas fa-plus"></i>
                </button>
                
                
                <div class="flex-grow relative">
                    <textarea id="message-input" rows="1" class="w-full pl-4 pr-12 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 resize-none" placeholder="Écris un message..." style="min-height: 48px; max-height: 120px;"></textarea>
                    <button type="button" class="absolute right-3 bottom-3 text-gray-400 hover:text-white">
                        <i class="far fa-smile"></i>
                    </button>
                </div>

                
                <button type="submit" id="send-btn" class="p-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl shadow-lg shadow-indigo-500/20 transition-all transform hover:scale-105 flex-shrink-0">
                    <i class="fas fa-paper-plane"></i>
                </button>

                <input type="file" id="file-input" class="hidden">
            </form>
        </footer>
    </div>

    
    <div id="share-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-3xl w-full max-w-md flex flex-col max-h-[80vh] shadow-2xl">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Partager du contenu</h2>
                <button id="close-share-modal" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="share-content-list" class="p-4 overflow-y-auto flex-grow space-y-2 custom-scrollbar">
                <div class="text-center py-8 text-gray-500">Chargement de votre bibliothèque...</div>
            </div>
            
            <div class="p-4 border-t border-gray-800 bg-gray-900/50 rounded-b-3xl text-center">
                <button id="cancel-share-btn" class="text-sm text-gray-400 hover:text-white font-medium">Annuler</button>
            </div>
        </div>
    </div>

    
    <div id="message-box" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    
    <script type="module">
        import { auth, db, storage } from '../../assets/js/config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { doc, getDoc, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, getDocs, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

        const recipientId = new URLSearchParams(window.location.search).get('with');
        let currentUserId = null;
        let chatId = null;
        let userSharableContent = [];
        let recipientProfile = null;
        let currentUserProfile = null;
        let lastMessageScrollHeight = 0; // Pour ne scroll qu'en cas de nouveau message

        const ui = {
            messagesContainer: document.getElementById('chat-messages'),
            messageForm: document.getElementById('message-form'),
            messageInput: document.getElementById('message-input'),
            recipientAvatar: document.getElementById('recipient-avatar'),
            recipientName: document.getElementById('recipient-name'),
            attachmentBtn: document.getElementById('attachment-btn'),
            fileInput: document.getElementById('file-input'),
            shareModal: document.getElementById('share-modal'),
            shareContentList: document.getElementById('share-content-list'),
            cancelShareBtn: document.getElementById('cancel-share-btn'),
            closeShareModal: document.getElementById('close-share-modal'),
            sendBtn: document.getElementById('send-btn'),
        };

        function showMessage(message, isError = false) {
            const box = document.createElement('div');
            box.className = `p-4 rounded-xl shadow-2xl text-white flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-500 pointer-events-auto border ${isError ? 'bg-gray-900 border-red-500/30' : 'bg-gray-900 border-green-500/30'}`;
            box.innerHTML = `
                <div class="${isError ? 'text-red-400' : 'text-green-400'} text-xl"><i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i></div>
                <p class="font-medium text-sm">${message}</p>
            `;
            document.getElementById('message-box').appendChild(box);
            requestAnimationFrame(() => { box.classList.remove('translate-y-10', 'opacity-0'); });
            setTimeout(() => { box.classList.add('translate-y-10', 'opacity-0'); setTimeout(() => box.remove(), 500); }, 4000);
        }

        function createChatId(user1, user2) {
            // Crée un ID unique et ordonné pour le chat 1:1
            return [user1, user2].sort().join('_');
        }

        function scrollToBottom() {
            // Scroll uniquement si un nouveau message arrive et que l'utilisateur n'est pas déjà en train de lire
            const messages = ui.messagesContainer;
            if (messages.scrollHeight > lastMessageScrollHeight) {
                messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
                lastMessageScrollHeight = messages.scrollHeight;
            }
        }

        // --- Content Loading ---
        async function loadSharableContent() {
            userSharableContent = [];
            const collectionsToFetch = [
                { name: 'courses', icon: 'fa-book', color: 'text-blue-400' }, 
                { name: 'quizzes', icon: 'fa-brain', color: 'text-purple-400' }, 
                { name: 'syntheses', icon: 'fa-magic', color: 'text-pink-400' }
            ];
            
            for (const { name, icon, color } of collectionsToFetch) {
                const ref = collection(db, 'users', currentUserId, name);
                const snapshot = await getDocs(ref);
                const items = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    collection: name, 
                    icon, 
                    color,
                    ...doc.data() 
                }));
                userSharableContent.push(...items);
            }
        }

        function populateShareModal() {
            ui.shareContentList.innerHTML = '';
            if (userSharableContent.length === 0) {
                ui.shareContentList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-600"><i class="fas fa-folder-open"></i></div>
                        <p class="text-gray-400">Aucun contenu à partager.</p>
                        <a href="upload.html" class="text-indigo-400 text-sm mt-2 block">Ajouter un cours</a>
                    </div>`;
                return;
            }
            
            userSharableContent.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-gray-800 hover:bg-gray-700/50 border border-gray-700 p-3 rounded-xl flex justify-between items-center transition-colors group cursor-pointer';
                el.onclick = () => shareContent(item);
                
                el.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center ${item.color}"><i class="fas ${item.icon}"></i></div>
                        <p class="font-medium text-white truncate text-sm">${item.title || item.name || item.fileName || 'Sans titre'}</p>
                    </div>
                    <button class="text-indigo-400 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-share"></i></button>
                `;
                ui.shareContentList.appendChild(el);
            });
        }

        async function shareContent(originalContent) {
            // 1. Créer une référence publique pour le contenu partagé (dans une collection `sharedContent`)
            // Ceci permet au destinataire d'ajouter une copie à sa librairie
            const publicContentRef = await addDoc(collection(db, 'sharedContent'), {
                ...originalContent,
                originalAuthorId: currentUserId,
                originalAuthorName: currentUserProfile.firstName || 'Utilisateur',
                sharedAt: serverTimestamp(),
            });

            // 2. Envoyer le message de partage
            await addDoc(collection(db, 'chats', chatId, 'messages'), {
                type: 'sharedContent',
                contentRefId: publicContentRef.id,
                contentTitle: originalContent.title || originalContent.name || originalContent.fileName,
                contentType: originalContent.collection,
                senderId: currentUserId,
                createdAt: serverTimestamp()
            });
            ui.shareModal.classList.add('hidden');
            showMessage("Contenu partagé !");
        }

        // --- Rendering Messages ---
        function renderMessage(data) {
            const isSender = data.senderId === currentUserId;
            const messageEl = document.createElement('div');
            messageEl.className = `flex items-end gap-2 mb-4 ${isSender ? 'justify-end' : 'justify-start'}`;
            
            let contentHtml = '';

            switch(data.type) {
                case 'file':
                    // Rendu de Fichier/Image
                    const isImage = data.fileType && data.fileType.startsWith('image/');
                    const isAudio = data.fileType && data.fileType.startsWith('audio/'); // Support Audio
                    
                    if (isImage) {
                        contentHtml = `<img src="${data.fileURL}" class="max-w-xs rounded-2xl border border-gray-700 cursor-pointer hover:opacity-90 transition-opacity" onclick="window.open('${data.fileURL}', '_blank')">`;
                    } else if (isAudio) {
                        contentHtml = `
                            <div class="p-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-xl transition-colors group flex items-center gap-3">
                                <i class="fas fa-volume-up text-indigo-400"></i>
                                <audio controls src="${data.fileURL}" class="max-w-[200px]"></audio>
                                <a href="${data.fileURL}" target="_blank" class="text-gray-500 hover:text-white" title="Télécharger"><i class="fas fa-download text-sm"></i></a>
                            </div>`;
                    } else {
                        contentHtml = `
                            <a href="${data.fileURL}" target="_blank" class="flex items-center gap-3 p-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-xl transition-colors group">
                                <div class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center text-indigo-400 group-hover:text-white transition-colors"><i class="fas fa-file-download"></i></div>
                                <div class="text-left">
                                    <p class="text-sm font-bold text-white truncate max-w-[150px]">${data.fileName}</p>
                                    <p class="text-xs text-gray-500 uppercase">Fichier</p>
                                </div>
                            </a>`;
                    }
                    break;
                case 'sharedContent':
                    // Rendu de Contenu Partagé (Quiz, Cours, Synthèse)
                    let typeIcon = 'fa-file-alt';
                    let typeColor = 'text-gray-400';
                    if (data.contentType === 'courses') { typeIcon = 'fa-book'; typeColor = 'text-blue-400'; }
                    if (data.contentType === 'quizzes') { typeIcon = 'fa-brain'; typeColor = 'text-purple-400'; }
                    if (data.contentType === 'syntheses') { typeIcon = 'fa-magic'; typeColor = 'text-pink-400'; }

                    contentHtml = `
                        <div class="p-4 bg-gray-800 border border-gray-700 rounded-xl w-64">
                            <div class="flex items-center gap-2 mb-2 text-xs text-gray-400 uppercase font-bold">
                                <i class="fas fa-share-alt"></i> Contenu Partagé
                            </div>
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center ${typeColor} text-lg"><i class="fas ${typeIcon}"></i></div>
                                <p class="font-bold text-white text-sm line-clamp-2">${data.contentTitle}</p>
                            </div>
                            <button data-content-id="${data.contentRefId}" data-content-type="${data.contentType}" class="add-content-btn w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition-colors">
                                Ajouter à ma bibliothèque
                            </button>
                        </div>`;
                    break;
                default: // text
                    const bubbleClass = isSender ? 'message-sent' : 'message-received';
                    contentHtml = `<div class="message-bubble ${bubbleClass} text-sm md:text-base">${data.text}</div>`;
            }
            
            messageEl.innerHTML = isSender ? contentHtml : 
                `<img src="${ui.recipientAvatar.src}" class="w-6 h-6 rounded-full object-cover mb-1 border border-gray-700 bg-gray-800 flex-shrink-0"> ${contentHtml}`;
            
            ui.messagesContainer.appendChild(messageEl);
        }

        // --- Handlers ---
        ui.messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = ui.messageInput.value.trim();
            if (text && chatId) {
                ui.messageInput.value = '';
                ui.messageInput.style.height = '48px'; // Reset height
                
                // Vider le focus pour éviter le spam et permettre l'envoi rapide
                ui.messageInput.blur(); 

                await addDoc(collection(db, 'chats', chatId, 'messages'), {
                    type: 'text',
                    text: text,
                    senderId: currentUserId,
                    createdAt: serverTimestamp()
                });
            }
        });

        // Auto-resize textarea
        ui.messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Enter to send (Shift+Enter for newline)
        ui.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                ui.messageForm.dispatchEvent(new Event('submit'));
            }
        });

        // Attachment / Share Logic
        ui.attachmentBtn.addEventListener('click', () => {
            // Afficher la modale pour le partage de contenu de la bibliothèque
            loadSharableContent().then(() => {
                populateShareModal();
                ui.shareModal.classList.remove('hidden');
            }).catch(e => {
                console.error("Erreur chargement bibliothèque:", e);
                showMessage("Erreur lors du chargement de la bibliothèque.", true);
            });
        });

        // File upload (via le bouton caché)
        ui.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) { // Limite de 10MB
                showMessage("Fichier trop lourd (max 10MB).", true);
                ui.fileInput.value = '';
                return;
            }

            showMessage("Envoi du fichier en cours...");
            
            // Logique d'upload vers Firebase Storage
            const storageRef = ref(storage, `chats/${chatId}/${Date.now()}_${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Progression de l'upload (pourrait être affichée dans la modale)
                }, 
                (error) => { showMessage("Erreur d'envoi du fichier.", true); }, 
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    await addDoc(collection(db, 'chats', chatId, 'messages'), {
                        type: 'file',
                        fileURL: downloadURL,
                        fileName: file.name,
                        fileType: file.type,
                        senderId: currentUserId,
                        createdAt: serverTimestamp()
                    });
                    showMessage("Fichier envoyé !");
                }
            );
        });

        // Share Modal Logic
        ui.cancelShareBtn.addEventListener('click', () => ui.shareModal.classList.add('hidden'));
        ui.closeShareModal.addEventListener('click', () => ui.shareModal.classList.add('hidden'));

        // Add Content Logic (delegated)
        ui.messagesContainer.addEventListener('click', async e => {
            const btn = e.target.closest('.add-content-btn');
            if (!btn) return;
            
            const contentId = btn.dataset.contentId;
            const destination = btn.dataset.contentType;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // 1. Récupérer le contenu public partagé
                const sharedRef = doc(db, 'sharedContent', contentId);
                const sharedSnap = await getDoc(sharedRef);
                
                if (sharedSnap.exists()) {
                    const data = sharedSnap.data();
                    // 2. Copier vers la collection de l'utilisateur courant
                    const destCollection = collection(db, 'users', currentUserId, destination);
                    
                    // On retire les champs liés au partage avant la copie
                    const { originalAuthorId, originalAuthorName, sharedAt, ...contentToCopy } = data;
                    
                    await addDoc(destCollection, {
                        ...contentToCopy,
                        addedFromShare: true,
                        addedAt: serverTimestamp()
                    });
                    
                    showMessage("Contenu ajouté à votre bibliothèque !", false);
                    
                    btn.textContent = 'Ajouté ✔';
                    btn.className = "w-full py-2 bg-green-500/20 text-green-400 text-xs font-bold rounded-lg cursor-default";
                } else {
                    throw new Error("Contenu partagé introuvable.");
                }
            } catch (e) {
                console.error("Erreur lors de l'ajout du contenu partagé:", e);
                showMessage("Erreur : Contenu non copié.", true);
                btn.textContent = 'Erreur';
            }
        });


        // --- Auth & Init ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = '../auth/login.html'; return; }
            currentUserId = user.uid;
            
            if (!recipientId) {
                // Redirection vers la liste si pas d'ID de destinataire
                window.location.href = 'chat-list.html';
                return;
            }
            
            chatId = createChatId(currentUserId, recipientId);

            // Load User Profiles
            const [recipientSnap, currentUserSnap] = await Promise.all([
                getDoc(doc(db, 'users', recipientId)),
                getDoc(doc(db, 'users', currentUserId))
            ]);
            
            if (recipientSnap.exists()) {
                recipientProfile = recipientSnap.data();
                ui.recipientName.textContent = `${recipientProfile.firstName} ${recipientProfile.lastName}`;
                ui.recipientAvatar.src = recipientProfile.photoURL || 'https://ui-avatars.com/api/?background=random';
            }
            if (currentUserSnap.exists()) {
                currentUserProfile = currentUserSnap.data();
            }

            // Listen for Messages
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('createdAt', 'asc'));

            onSnapshot(q, (snapshot) => {
                const isInitialLoad = ui.messagesContainer.children.length === 1; // 1 because of the flex-grow spacer
                ui.messagesContainer.innerHTML = '';
                
                // Re-add spacer
                const spacer = document.createElement('div');
                spacer.className = "flex-grow min-h-[1px]";
                ui.messagesContainer.appendChild(spacer);
                
                snapshot.forEach(doc => renderMessage(doc.data()));
                
                // Scroll to bottom only if it's the initial load OR a new message arrived
                if (isInitialLoad || snapshot.docChanges().some(change => change.type === 'added')) {
                    setTimeout(scrollToBottom, 50);
                }
            });
        });
    </script>
</body>
</html>