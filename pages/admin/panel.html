<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Projet Blocus</title>
    <link rel="icon" type="image/png" href="../../../assets/images/locus-neon-favicon.png">
    
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/mobile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../../assets/css/style.css">
</head>
<body class="bg-black text-white min-h-screen font-sans selection:bg-red-500 selection:text-white">

    <nav class="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center font-bold text-white">A</div>
                <span class="font-bold text-lg">Admin Panel</span>
            </div>
            <a href="../dashboard.html" class="text-sm text-gray-400 hover:text-white transition-colors">Retour App</a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 sm:py-10">
        
        <div id="loading-admin" class="text-center py-20">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-red-500 mx-auto mb-4"></div>
            <p class="text-gray-500">Vérification des privilèges...</p>
        </div>

        <div id="admin-content" class="hidden space-y-10">
            
            
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
                <div class="bg-gray-900 border border-gray-800 p-4 sm:p-6 rounded-xl">
                    <p class="text-gray-500 text-xs sm:text-sm font-bold uppercase mb-1 sm:mb-2">Utilisateurs</p>
                    <p id="count-users" class="text-2xl sm:text-3xl font-bold text-white">-</p>
                </div>
                <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl">
                    <p class="text-gray-500 text-xs font-bold uppercase mb-1">Rapports de bugs</p>
                    <p id="count-bugs" class="text-3xl font-bold text-red-400">-</p>
                </div>
                <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl">
                    <p class="text-gray-500 text-xs font-bold uppercase mb-1">Discussions</p>
                    <p id="count-posts" class="text-3xl font-bold text-indigo-400">-</p>
                </div>
            </div>

            
            <div>
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-bug text-red-500"></i> Rapports Récents
                </h2>
                <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-gray-800 text-gray-200 uppercase text-xs font-bold">
                            <tr>
                                <th class="px-6 py-3">Gravité</th>
                                <th class="px-6 py-3">Sujet</th>
                                <th class="px-6 py-3">Utilisateur</th>
                                <th class="px-6 py-3">Date</th>
                                <th class="px-6 py-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body" class="divide-y divide-gray-800">
                            
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <div id="access-denied" class="hidden text-center py-20">
            <div class="w-20 h-20 bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-red-500">
                <i class="fas fa-lock"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Accès Refusé</h1>
            <p class="text-gray-500">Vous n'avez pas les permissions nécessaires.</p>
            <a href="../dashboard.html" class="inline-block mt-6 px-6 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors">Retour</a>
        </div>

    </main>

    <script type="module">
        import { auth, db } from '../../../assets/js/supabase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { doc, getDoc, collection, getDocs, query, orderBy, limit, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const ui = {
            loading: document.getElementById('loading-admin'),
            content: document.getElementById('admin-content'),
            denied: document.getElementById('access-denied'),
            reportsTable: document.getElementById('reports-table-body'),
            countUsers: document.getElementById('count-users'),
            countBugs: document.getElementById('count-bugs'),
            countPosts: document.getElementById('count-posts'),
        };

        async function loadDashboard() {
            // 1. Fetch Stats (Simple counting via size - not efficient for huge datasets but ok for MVP)
            const [usersSnap, bugsSnap, postsSnap] = await Promise.all([
                getDocs(collection(db, 'users')),
                getDocs(collection(db, 'reports')),
                getDocs(collection(db, 'forum'))
            ]);

            ui.countUsers.textContent = usersSnap.size;
            ui.countBugs.textContent = bugsSnap.size;
            ui.countPosts.textContent = postsSnap.size;

            // 2. Fetch Reports
            const reportsQuery = query(collection(db, 'reports'), orderBy('createdAt', 'desc'), limit(10));
            const reportsSnap = await getDocs(reportsQuery);

            ui.reportsTable.innerHTML = '';
            reportsSnap.forEach(doc => {
                const r = doc.data();
                const severityColors = { 'low': 'text-green-400', 'medium': 'text-yellow-400', 'high': 'text-red-500 font-bold' };
                const severityLabels = { 'low': 'Mineur', 'medium': 'Gênant', 'high': 'CRITIQUE' };
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-800/50 transition-colors";
                tr.innerHTML = `
                    <td class="px-6 py-4 ${severityColors[r.severity]}">${severityLabels[r.severity]}</td>
                    <td class="px-6 py-4 font-medium text-white">${r.title}</td>
                    <td class="px-6 py-4">${r.userEmail}</td>
                    <td class="px-6 py-4">${r.createdAt ? new Date(r.createdAt.toDate()).toLocaleDateString() : '-'}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-red-400 hover:text-white transition-colors" onclick="deleteReport('${doc.id}')">
                            <i class="fas fa-check"></i> Traiter
                        </button>
                    </td>
                `;
                ui.reportsTable.appendChild(tr);
            });

            window.deleteReport = async (id) => {
                if(confirm("Marquer comme traité et supprimer ?")) {
                    await deleteDoc(doc(db, 'reports', id));
                    loadDashboard(); // Reload
                }
            };
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists() && userSnap.data().role === 'admin') {
                    ui.loading.classList.add('hidden');
                    ui.content.classList.remove('hidden');
                    loadDashboard();
                } else {
                    ui.loading.classList.add('hidden');
                    ui.denied.classList.remove('hidden');
                }
            } else {
                window.location.href = '../../auth/login.html';
            }
        });
    </script>
</body>
</html>