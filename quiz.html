<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Quiz & Flashcards - Projet Blocus</title>
    <link rel="icon" type="image/png" href="images/logo.png" onerror="this.onerror=null;this.src='[https://firebasestorage.googleapis.com/v0/b/chatbot-playground-c0c32.appspot.com/o/opera_xnPtx6KH7F.png?alt=media&token=c191a3ec-80f0-466d-9788-b7f33d79047c](https://firebasestorage.googleapis.com/v0/b/chatbot-playground-c0c32.appspot.com/o/opera_xnPtx6KH7F.png?alt=media&token=c191a3ec-80f0-466d-9788-b7f33d79047c)';">
    <link rel="preconnect" href="[https://fonts.googleapis.com](https://fonts.googleapis.com)">
    <link rel="preconnect" href="[https://fonts.gstatic.com](https://fonts.gstatic.com)" crossorigin>
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap)" rel="stylesheet">
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link rel="stylesheet" href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css)">
    <!-- PDF.js worker -->
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js](https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js)"></script>
    <style> 
        body { font-family: 'Inter', sans-serif; }
        /* Style pour les options de quiz s√©lectionn√©es */
        .option-label:has(input:checked) { background-color: #4f46e5; border-color: #6366f1; }
        /* Style pour la liste de s√©lection des cours */
        #course-select { height: 150px; }
        #course-select option { padding: 8px; }
        #course-select option:checked { background-color: #4f46e5; color: white; }
        /* Style pour la barre de progression du minuteur */
        #timer-progress-bar, #question-timer-bar { transition: width 1s linear; }
        /* Cacher les marqueurs de liste pour les 'details' */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        /* Styles pour les flashcards */
        .flashcard-container { perspective: 1000px; }
        .flashcard { width: 100%; height: 300px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 2rem; border-radius: 0.75rem; border: 1px solid #4b5563; }
        .flashcard-front { background-color: #374151; }
        .flashcard-back { background-color: #4f46e5; transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <header class="flex justify-between items-center p-6 bg-gray-900 shadow-lg w-full z-20 sticky top-0">
        <a href="/dashboard.html" class="flex items-center space-x-2">
            <img src="images/logo.png" onerror="this.onerror=null;this.src='[https://firebasestorage.googleapis.com/v0/b/chatbot-playground-c0c32.appspot.com/o/opera_xnPtx6KH7F.png?alt=media&token=c191a3ec-80f0-466d-9788-b7f33d79047c](https://firebasestorage.googleapis.com/v0/b/chatbot-playground-c0c32.appspot.com/o/opera_xnPtx6KH7F.png?alt=media&token=c191a3ec-80f0-466d-9788-b7f33d79047c)';" alt="Logo Projet Blocus" class="h-10">
        </a>
        <nav id="nav-logged-in" class="hidden items-center relative">
            <button id="user-menu-button" class="flex items-center space-x-3 text-white hover:text-indigo-400 transition-colors duration-300">
                <img id="user-avatar-header" src="[https://placehold.co/32x32/4b5563/ffffff?text=](https://placehold.co/32x32/4b5563/ffffff?text=)üë§" class="h-8 w-8 rounded-full object-cover border-2 border-indigo-500">
                <span id="user-name-header" class="font-semibold">Chargement...</span>
                <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div id="user-menu" class="hidden absolute top-12 right-0 bg-gray-800 rounded-lg shadow-xl w-48 py-2 border border-gray-700">
                <a href="/dashboard.html" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">Tableau de Bord</a>
                <a href="/profile.html" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">Mon Profil</a>
                <hr class="border-gray-600 my-2">
                <button id="logout-button" class="w-full text-left px-4 py-2 text-red-400 hover:bg-red-500 hover:text-white">Se d√©connecter</button>
            </div>
        </nav>
    </header>

    <main class="w-full max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- SECTION 1 : LISTE DES QUIZ SAUVEGARD√âS -->
        <section id="quiz-list-section">
             <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold">Mes Quiz & Flashcards</h1>
                <button id="go-to-generator-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg flex items-center space-x-2">
                    <i class="fas fa-plus-circle"></i>
                    <span>Nouveau Contenu</span>
                </button>
            </div>
            <div id="saved-quizzes-list" class="space-y-4"></div>
            <div id="loading-quizzes" class="text-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-indigo-400"></i></div>
            <div id="no-quizzes" class="hidden text-center py-12 bg-gray-800 rounded-lg"><i class="fas fa-clipboard-question text-5xl text-gray-500 mb-4"></i><h3 class="text-2xl font-bold">Aucun contenu sauvegard√©</h3><p class="mt-2 text-gray-400">Cr√©ez votre premier quiz ou jeu de flashcards pour le voir appara√Ætre ici.</p></div>
        </section>

        <!-- SECTION 2 : FORMULAIRE DE CR√âATION -->
        <section id="quiz-setup-section" class="hidden">
            <button id="back-to-list-btn" class="text-indigo-400 hover:text-indigo-300 mb-6 inline-block"><i class="fas fa-arrow-left mr-2"></i>Retour √† la liste</button>
            <h1 id="generator-title" class="text-4xl font-bold mb-2">G√©n√©rateur de Contenu IA</h1>
            <p class="text-gray-400 mb-8">Configurez votre contenu sur mesure.</p>
            
            <form id="quiz-generator-form" class="bg-gray-800 p-8 rounded-xl border border-gray-700 space-y-6">
                <input type="hidden" id="content-type-hidden">
                <div>
                    <label for="quiz-title-input" class="block text-lg font-bold mb-2">1. Titre</label>
                    <input type="text" id="quiz-title-input" class="w-full px-4 py-3 rounded-lg bg-gray-700" placeholder="Ex: Quiz de r√©vision Chapitre 1" required>
                </div>
                <div>
                    <label for="course-select" class="block text-lg font-bold mb-2">2. Choisir un ou plusieurs cours (Ctrl+Clic)</label>
                    <select id="course-select" multiple class="w-full p-2 rounded-lg bg-gray-700" required></select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="question-count" class="block text-lg font-bold mb-2">3. Nombre d'√©l√©ments</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="question-count" min="5" max="50" value="10" class="w-full">
                            <span id="question-count-value" class="font-bold text-indigo-400 text-xl w-16 text-center">10</span>
                        </div>
                    </div>
                    <div>
                        <label for="difficulty-select" class="block text-lg font-bold mb-2">4. Difficult√©</label>
                        <select id="difficulty-select" class="w-full px-4 py-3 rounded-lg bg-gray-700">
                            <option value="Facile">Facile</option>
                            <option value="Moyen" selected>Moyen</option>
                            <option value="Difficile">Difficile</option>
                        </select>
                    </div>
                </div>
                <div id="quiz-type-container">
                    <label for="quiz-type" class="block text-lg font-bold mb-2">5. Type de questions</label>
                    <select id="quiz-type" class="w-full px-4 py-3 rounded-lg bg-gray-700">
                        <option value="QCM">QCM (Choix multiples)</option>
                        <option value="Vrai/Faux">Vrai / Faux</option>
                        <option value="R√©ponse Courte">R√©ponse Courte</option>
                    </select>
                </div>
                <div id="timer-config-container" class="bg-gray-900 p-4 rounded-lg">
                    <p class="text-lg font-bold mb-3">Options du minuteur</p>
                    <div class="flex items-center justify-between mb-4">
                        <label for="timer-toggle" class="font-semibold">Activer le minuteur</label>
                        <input type="checkbox" id="timer-toggle" class="form-checkbox h-6 w-6 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500">
                    </div>
                    <div id="timer-options" class="hidden space-y-4">
                        <div class="flex items-center">
                            <input type="radio" id="timer-global" name="timer-type" value="global" class="h-4 w-4 text-indigo-600" checked>
                            <label for="timer-global" class="ml-3 block text-sm font-medium">Temps total pour le quiz (minutes)</label>
                        </div>
                        <input type="number" id="timer-global-value" min="1" value="10" class="w-full p-2 bg-gray-700 rounded-lg">
                        
                        <div class="flex items-center">
                            <input type="radio" id="timer-per-question" name="timer-type" value="per-question" class="h-4 w-4 text-indigo-600">
                            <label for="timer-per-question" class="ml-3 block text-sm font-medium">Temps par question (secondes)</label>
                        </div>
                        <input type="number" id="timer-per-question-value" min="10" value="30" class="w-full p-2 bg-gray-700 rounded-lg">
                    </div>
                </div>
                <div>
                    <label for="custom-instruction" class="block text-lg font-bold mb-2">Instruction pour l'IA (optionnel)</label>
                    <textarea id="custom-instruction" rows="2" class="w-full p-3 bg-gray-700 rounded-lg" placeholder="Ex: Concentre-toi sur les dates importantes..."></textarea>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-lg text-xl flex items-center justify-center">
                    <i class="fas fa-magic-sparkles mr-3"></i>
                    G√©n√©rer
                </button>
            </form>
        </section>

        <!-- SECTION 3 : √âCRAN DE CHARGEMENT -->
        <section id="quiz-loading-section" class="hidden text-center py-20">
            <i class="fas fa-spinner fa-spin text-6xl text-indigo-400"></i>
            <h2 class="text-3xl font-bold mt-6">G√©n√©ration en cours...</h2>
            <p class="text-gray-400 mt-2">L'IA pr√©pare votre contenu. Cela peut prendre un moment.</p>
        </section>

        <!-- SECTION 4 : QUIZ EN COURS -->
        <section id="quiz-taking-section" class="hidden">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="quiz-title" class="text-2xl font-bold truncate">Titre du Quiz</h2>
                    <div id="timer-display" class="text-xl font-bold bg-gray-700 px-4 py-2 rounded-lg"></div>
                </div>
                <div id="question-timer-bar-container" class="w-full bg-gray-700 rounded-full h-1.5 mb-6 hidden">
                    <div id="question-timer-bar" class="bg-indigo-500 h-1.5 rounded-full"></div>
                </div>
                
                <div id="quiz-questions-container">
                    <!-- Les questions seront inject√©es ici par le JS -->
                </div>

                <div class="flex justify-between items-center mt-6">
                    <button id="prev-question-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-lg">Pr√©c√©dent</button>
                    <p id="question-progress" class="font-semibold text-gray-400"></p>
                    <button id="next-question-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg">Suivant</button>
                    <button id="submit-quiz-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg">Terminer</button>
                </div>
            </div>
            <div class="text-center mt-4">
                <button id="quit-quiz-btn" class="text-sm text-red-400 hover:underline">Quitter le quiz</button>
            </div>
        </section>

        <!-- SECTION 5 : R√âSULTATS DU QUIZ -->
        <section id="quiz-results-section" class="hidden text-center">
            <div class="bg-gray-800 p-8 rounded-xl border border-gray-700">
                <i class="fas fa-trophy text-6xl text-yellow-400 mb-4"></i>
                <h2 class="text-4xl font-bold">R√©sultats</h2>
                <p id="results-subtitle" class="text-gray-400 text-lg mt-2 mb-6"></p>
                
                <div class="bg-gray-900 inline-block p-6 rounded-full border-4 border-indigo-500 mb-6">
                    <p id="score-text" class="text-5xl font-extrabold"></p>
                </div>
                <p id="score-percentage" class="text-2xl font-semibold mb-8"></p>

                <div class="flex justify-center space-x-4 mb-8">
                    <button id="restart-quiz-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Retour √† la liste</button>
                    <button id="review-errors-btn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg">Revoir mes erreurs</button>
                    <button id="share-results-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Partager</button>
                </div>

                <div id="results-summary" class="space-y-4 text-left">
                    <!-- Le r√©sum√© des r√©ponses sera inject√© ici -->
                </div>
            </div>
        </section>

        <!-- SECTION 6 : FLASHCARDS -->
        <section id="flashcard-section" class="hidden">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h2 id="flashcard-title" class="text-2xl font-bold truncate text-center mb-6"></h2>
                <div class="flashcard-container">
                    <div id="flashcard" class="flashcard">
                        <div id="flashcard-front" class="flashcard-face flashcard-front"></div>
                        <div id="flashcard-back" class="flashcard-face flashcard-back"></div>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button id="flip-card-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">
                        <i class="fas fa-sync-alt mr-2"></i>Retourner
                    </button>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button id="prev-card-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-lg">Pr√©c√©dent</button>
                    <p id="card-progress" class="font-semibold text-gray-400"></p>
                    <button id="next-card-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-lg">Suivant</button>
                </div>
            </div>
             <div class="text-center mt-4">
                <button id="back-to-list-from-flashcards-btn" class="text-sm text-indigo-400 hover:underline">Retour √† la liste</button>
            </div>
        </section>

    </main>
    
    <!-- Modale pour choisir le type de contenu -->
    <div id="content-choice-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40">
        <div class="bg-gray-800 rounded-lg p-8 shadow-xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-6">Que voulez-vous cr√©er ?</h2>
            <div class="flex justify-center space-x-4">
                <button data-type="Quiz" class="content-choice-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-lg flex flex-col items-center space-y-2 w-40">
                    <i class="fas fa-question-circle text-3xl"></i><span>Quiz</span>
                </button>
                <button data-type="Flashcards" class="content-choice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-lg flex flex-col items-center space-y-2 w-40">
                    <i class="fas fa-clone text-3xl"></i><span>Flashcards</span>
                </button>
            </div>
             <button id="cancel-choice-btn" class="mt-6 text-gray-400 hover:text-white">Annuler</button>
        </div>
    </div>

    <!-- Conteneur pour les messages/notifications -->
    <div id="message-box" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script type="module">
        // Importation des modules Firebase
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "[https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js](https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js)";
        import { doc, getDoc, collection, getDocs, addDoc, serverTimestamp, updateDoc, onSnapshot, deleteDoc } from "[https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js](https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js)";

        // --- VARIABLES GLOBALES ---
        let userCourses = [];
        let currentContent = null;
        let currentContentId = null;
        let timerInterval = null;
        let currentItemIndex = 0;
        let userAnswers = [];
        let wrongAnswers = [];

        // --- S√âLECTEURS D'√âL√âMENTS UI ---
        const ui = {
            list: document.getElementById('quiz-list-section'),
            setup: document.getElementById('quiz-setup-section'),
            loading: document.getElementById('quiz-loading-section'),
            taking: document.getElementById('quiz-taking-section'),
            results: document.getElementById('quiz-results-section'),
            flashcard: document.getElementById('flashcard-section'),
            form: document.getElementById('quiz-generator-form'),
            courseSelect: document.getElementById('course-select'),
            questionCount: document.getElementById('question-count'),
            questionCountValue: document.getElementById('question-count-value'),
            quizType: document.getElementById('quiz-type'),
            quizTitle: document.getElementById('quiz-title'),
            questionsContainer: document.getElementById('quiz-questions-container'),
            submitQuizBtn: document.getElementById('submit-quiz-btn'),
            resultsSubtitle: document.getElementById('results-subtitle'),
            scoreText: document.getElementById('score-text'),
            scorePercentage: document.getElementById('score-percentage'),
            resultsSummary: document.getElementById('results-summary'),
            restartQuizBtn: document.getElementById('restart-quiz-btn'),
            navLoggedIn: document.getElementById('nav-logged-in'),
            userMenuButton: document.getElementById('user-menu-button'),
            userMenu: document.getElementById('user-menu'),
            logoutButton: document.getElementById('logout-button'),
            goToGeneratorBtn: document.getElementById('go-to-generator-btn'),
            backToListBtn: document.getElementById('back-to-list-btn'),
            savedQuizzesList: document.getElementById('saved-quizzes-list'),
            loadingQuizzes: document.getElementById('loading-quizzes'),
            noQuizzes: document.getElementById('no-quizzes'),
            timerDisplay: document.getElementById('timer-display'),
            questionTimerBarContainer: document.getElementById('question-timer-bar-container'),
            questionTimerBar: document.getElementById('question-timer-bar'),
            prevQuestionBtn: document.getElementById('prev-question-btn'),
            nextQuestionBtn: document.getElementById('next-question-btn'),
            quitQuizBtn: document.getElementById('quit-quiz-btn'),
            questionProgress: document.getElementById('question-progress'),
            timerToggle: document.getElementById('timer-toggle'),
            timerOptions: document.getElementById('timer-options'),
            reviewErrorsBtn: document.getElementById('review-errors-btn'),
            shareResultsBtn: document.getElementById('share-results-btn'),
            flashcardTitle: document.getElementById('flashcard-title'),
            flipCardBtn: document.getElementById('flip-card-btn'),
            prevCardBtn: document.getElementById('prev-card-btn'),
            nextCardBtn: document.getElementById('next-card-btn'),
            cardProgress: document.getElementById('card-progress'),
            backToListFromFlashcardsBtn: document.getElementById('back-to-list-from-flashcards-btn'),
            contentChoiceModal: document.getElementById('content-choice-modal'),
            cancelChoiceBtn: document.getElementById('cancel-choice-btn'),
            quizTypeContainer: document.getElementById('quiz-type-container'),
            timerConfigContainer: document.getElementById('timer-config-container'),
            generatorTitle: document.getElementById('generator-title'),
            contentTypeHidden: document.getElementById('content-type-hidden'),
        };

        // --- FONCTIONS UTILITAIRES ---

        // Affiche un message de notification
        function showMessage(message, isError = false) {
            const box = document.createElement('div');
            box.textContent = message;
            box.className = `p-4 rounded-lg shadow-xl ${isError ? 'bg-red-600' : 'bg-green-600'} text-white`;
            document.getElementById('message-box').appendChild(box);
            setTimeout(() => { box.remove(); }, 5000);
        }

        // Affiche une section sp√©cifique de la page et cache les autres
        function showSection(section) {
            ['list', 'setup', 'loading', 'taking', 'results', 'flashcard'].forEach(s => ui[s].classList.add('hidden'));
            ui[section].classList.remove('hidden');
        }

        // Ouvre le formulaire de g√©n√©ration en adaptant l'UI au type de contenu (Quiz/Flashcards)
        function openGenerator(type) {
            showSection('setup');
            ui.contentTypeHidden.value = type;
            if (type === 'Flashcards') {
                ui.generatorTitle.textContent = 'G√©n√©rateur de Flashcards IA';
                ui.quizTypeContainer.classList.add('hidden');
                ui.timerConfigContainer.classList.add('hidden');
            } else {
                ui.generatorTitle.textContent = 'G√©n√©rateur de Quiz IA';
                ui.quizTypeContainer.classList.remove('hidden');
                ui.timerConfigContainer.classList.remove('hidden');
            }
        }

        // --- GESTION DES DONN√âES (Firebase & PDF) ---

        // R√©cup√®re les cours de l'utilisateur depuis Firestore et les affiche dans le select
        async function populateCourses() {
            const coursesRef = collection(db, 'users', auth.currentUser.uid, 'courses');
            const coursesSnap = await getDocs(coursesRef);
            userCourses = coursesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            ui.courseSelect.innerHTML = '';
            if (userCourses.length === 0) {
                ui.courseSelect.innerHTML = '<option value="" disabled>Veuillez d\'abord uploader un cours</option>';
            } else {
                userCourses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    ui.courseSelect.appendChild(option);
                });
            }
        }

        // Extrait le texte brut d'un fichier PDF √† partir de son URL
        async function extractTextFromPdf(url) {
            // Configure le worker pour PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
            // Charge le document PDF
            const pdf = await pdfjsLib.getDocument(url).promise;
            let fullText = '';
            // It√®re sur chaque page pour extraire le texte
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            return fullText;
        }

        // --- G√âN√âRATION DE CONTENU (API Gemini) ---

        // G√®re la soumission du formulaire de g√©n√©ration
        async function generateContent(e) {
            e.preventDefault();
            const selectedOptions = [...ui.courseSelect.selectedOptions];
            if (selectedOptions.length === 0) {
                showMessage('Veuillez s√©lectionner au moins un cours.', true);
                return;
            }
            showSection('loading'); // Affiche l'√©cran de chargement

            try {
                // Combine le texte de tous les cours s√©lectionn√©s
                let combinedText = '';
                for (const option of selectedOptions) {
                    const course = userCourses.find(c => c.id === option.value);
                    if (course) {
                        combinedText += `--- Contenu du cours: ${course.name} ---\n`;
                        const text = await extractTextFromPdf(course.url);
                        combinedText += text + '\n\n';
                    }
                }

                const count = ui.questionCount.value;
                const type = ui.contentTypeHidden.value;
                const difficulty = document.getElementById('difficulty-select').value;
                const customInstruction = document.getElementById('custom-instruction').value.trim();
                
                // Construction du prompt pour l'API Gemini
                let prompt;
                let schema;

                if (type === 'Flashcards') {
                    schema = {
                        type: "OBJECT",
                        properties: {
                            flashcards: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        term: { type: "STRING" },
                                        definition: { type: "STRING" }
                                    },
                                    required: ["term", "definition"]
                                }
                            }
                        }
                    };
                    prompt = `√Ä partir du texte fourni, g√©n√®re ${count} flashcards de difficult√© "${difficulty}". Chaque flashcard doit avoir un "term" (terme cl√©) et une "definition". ${customInstruction}`;
                } else { // C'est un Quiz
                    const quizType = ui.quizType.value;
                    schema = {
                        type: "OBJECT",
                        properties: {
                            quiz: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        question: { type: "STRING" },
                                        options: { type: "ARRAY", items: { type: "STRING" } },
                                        answer: { type: "STRING" },
                                        explanation: { type: "STRING" }
                                    },
                                    required: ["question", "answer"]
                                }
                            }
                        }
                    };
                    prompt = `√Ä partir du texte fourni, g√©n√®re un quiz de type "${quizType}" avec ${count} questions de difficult√© "${difficulty}". Pour chaque question, fournis la "question", la "answer" (r√©ponse correcte), et une "explanation" (br√®ve explication). Pour les QCM, fournis aussi un tableau "options" avec 4 choix incluant la bonne r√©ponse. ${customInstruction}`;
                }

                const apiKey = "AIzaSyAR4rQ7Ev5Fe24NeWmmo1aP8BxUFR_aqIw";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-preview-0514:generateContent?key=${apiKey}`;
                
                const payload = { 
                    contents: [{ parts: [{ text: prompt }] }], 
                    generationConfig: { 
                        responseMimeType: "application/json",
                        responseSchema: schema
                    } 
                };
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => response.text());
                    console.error("API Error Body:", errorBody);
                    throw new Error(`Erreur de l'API Gemini: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    console.error("Invalid API response structure:", result);
                    throw new Error("R√©ponse de l'API invalide ou vide.");
                }

                let responseText = result.candidates[0].content.parts[0].text;
                
                // Nettoyage robuste du JSON
                if (responseText.startsWith("```json")) {
                    responseText = responseText.substring(7, responseText.length - 3).trim();
                } else if (responseText.startsWith("```")) {
                    responseText = responseText.substring(3, responseText.length - 3).trim();
                }
                
                try {
                    currentContent = JSON.parse(responseText);
                } catch (parseError) {
                    console.error("Erreur de parsing JSON:", parseError);
                    console.error("Texte re√ßu de l'API qui a caus√© l'erreur:", responseText);
                    throw new Error("La r√©ponse de l'IA n'√©tait pas un format JSON valide.");
                }

                // Sauvegarde du contenu g√©n√©r√© dans Firestore
                const title = document.getElementById('quiz-title-input').value;
                const contentData = type === 'Flashcards' ? currentContent.flashcards : currentContent.quiz;
                
                const contentRef = await addDoc(collection(db, 'users', auth.currentUser.uid, 'quizzes'), {
                    title: title,
                    type: type,
                    content: contentData,
                    createdAt: serverTimestamp()
                });
                currentContentId = contentRef.id;

                // Affichage du contenu g√©n√©r√©
                if (type === 'Flashcards') {
                    displayFlashcards(title, contentData);
                } else {
                    displayQuiz(title, contentData);
                }

            } catch (error) {
                console.error("Erreur de g√©n√©ration:", error);
                showMessage(`La g√©n√©ration a √©chou√©. L'IA a peut-√™tre eu un souci. R√©essayez. (${error.message})`, true);
                showSection('setup');
            }
        }


        // --- AFFICHAGE ET LOGIQUE DU QUIZ ---

        // Affiche le quiz √† l'utilisateur
        function displayQuiz(title, questions) {
            currentContent = { quiz: questions, title: title };
            userAnswers = new Array(questions.length).fill(null);
            currentItemIndex = 0;
            ui.quizTitle.textContent = title;
            showQuestion(currentItemIndex);
            startTimer();
            showSection('taking');
        }
        
        // Affiche une question sp√©cifique
        function showQuestion(index) {
            ui.questionsContainer.innerHTML = '';
            const q = currentContent.quiz[index];
            if (!q) return; // S√©curit√© si la question n'existe pas

            const questionEl = document.createElement('div');
            questionEl.className = 'bg-gray-800 p-6 rounded-lg border border-gray-700';
            
            let optionsHtml = '';
            // G√©n√®re les options pour QCM/VraiFaux ou un champ de texte pour les autres
            if (q.options && q.options.length > 0) {
                optionsHtml = q.options.map((opt) => {
                    const isChecked = userAnswers[index] === opt ? 'checked' : '';
                    return `<div><label class="option-label block bg-gray-700 p-4 rounded-lg border-2 border-gray-600 hover:border-indigo-500 cursor-pointer"><input type="radio" name="q${index}" value="${opt}" class="hidden" ${isChecked}><span>${opt}</span></label></div>`;
                }).join('');
            } else {
                const value = userAnswers[index] || '';
                optionsHtml = `<input type="text" name="q${index}" class="w-full p-3 bg-gray-700 rounded-lg border-2 border-gray-600" placeholder="Votre r√©ponse..." value="${value}">`;
            }

            questionEl.innerHTML = `<p class="text-xl font-bold mb-4">${index + 1}. ${q.question}</p><div class="space-y-3">${optionsHtml}</div>`;
            ui.questionsContainer.appendChild(questionEl);
            
            // Mise √† jour de la navigation du quiz
            ui.questionProgress.textContent = `Question ${index + 1} / ${currentContent.quiz.length}`;
            ui.prevQuestionBtn.disabled = index === 0;
            ui.nextQuestionBtn.classList.toggle('hidden', index === currentContent.quiz.length - 1);
            ui.submitQuizBtn.classList.toggle('hidden', index !== currentContent.quiz.length - 1);
        }

        // Sauvegarde la r√©ponse de l'utilisateur pour la question actuelle
        function saveAnswer() {
            const input = document.querySelector(`[name="q${currentItemIndex}"]:checked`) || document.querySelector(`[name="q${currentItemIndex}"]`);
            if (input) {
                userAnswers[currentItemIndex] = input.value;
            }
        }

        // D√©marre le minuteur du quiz s'il est activ√©
        function startTimer() {
            clearInterval(timerInterval);
            if (!ui.timerToggle.checked) {
                ui.timerDisplay.classList.add('hidden');
                return;
            }
            
            ui.timerDisplay.classList.remove('hidden');
            const timerType = document.querySelector('input[name="timer-type"]:checked').value;
            
            if (timerType === 'global') {
                let time = parseInt(document.getElementById('timer-global-value').value) * 60;
                timerInterval = setInterval(() => {
                    const minutes = Math.floor(time / 60);
                    const seconds = time % 60;
                    ui.timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    if (time-- <= 0) {
                        clearInterval(timerInterval);
                        submitQuiz();
                    }
                }, 1000);
            }
        }

        // G√®re la soumission du quiz et calcule les r√©sultats
        async function submitQuiz() {
            clearInterval(timerInterval);
            saveAnswer();
            let score = 0;
            wrongAnswers = [];
            ui.resultsSummary.innerHTML = '';

            currentContent.quiz.forEach((q, index) => {
                const userAnswer = userAnswers[index] || '';
                // Comparaison robuste insensible √† la casse et aux espaces
                const isCorrect = String(userAnswer).toLowerCase().trim() === String(q.answer).toLowerCase().trim();
                
                if (isCorrect) {
                    score++;
                } else {
                    wrongAnswers.push(q);
                }
                
                // Cr√©ation de l'√©l√©ment de r√©sum√© pour chaque question
                const resultEl = document.createElement('details');
                resultEl.className = `p-4 rounded-lg ${isCorrect ? 'bg-green-900 border-green-700' : 'bg-red-900 border-red-700'} border`;
                resultEl.innerHTML = `
                    <summary class="flex justify-between items-center cursor-pointer">
                        <p class="font-bold">${index + 1}. ${q.question}</p>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </summary>
                    <div class="mt-4 pt-4 border-t border-gray-600">
                        <p class="text-sm">Votre r√©ponse : <span class="${isCorrect ? 'text-green-300' : 'text-red-300'}">${userAnswer || "Aucune"}</span></p>
                        ${!isCorrect ? `<p class="text-sm">R√©ponse correcte : <span class="text-green-300">${q.answer}</span></p>` : ''}
                        ${q.explanation ? `<p class="text-sm mt-2 text-gray-400"><em>Explication : ${q.explanation}</em></p>` : ''}
                    </div>
                `;
                ui.resultsSummary.appendChild(resultEl);
            });

            const total = currentContent.quiz.length;
            const percentage = Math.round((score / total) * 100);
            
            // Mise √† jour du score dans Firestore
            if (currentContentId) {
                await updateDoc(doc(db, 'users', auth.currentUser.uid, 'quizzes', currentContentId), {
                    lastResult: { score, total, percentage, completedAt: serverTimestamp() }
                });
            }

            // Affichage de l'√©cran des r√©sultats
            ui.scoreText.textContent = `${score}/${total}`;
            ui.scorePercentage.textContent = `Soit ${percentage}% de bonnes r√©ponses !`;
            ui.resultsSubtitle.textContent = `R√©sultats pour : ${currentContent.title}`;
            ui.reviewErrorsBtn.classList.toggle('hidden', wrongAnswers.length === 0);
            showSection('results');
        }

        // --- AFFICHAGE ET LOGIQUE DES FLASHCARDS ---

        // Affiche l'interface des flashcards
        function displayFlashcards(title, flashcards) {
            currentContent = { flashcards: flashcards, title: title };
            currentItemIndex = 0;
            ui.flashcardTitle.textContent = title;
            showFlashcard(currentItemIndex);
            showSection('flashcard');
        }

        // Affiche une flashcard sp√©cifique
        function showFlashcard(index) {
            const card = currentContent.flashcards[index];
            if (!card) return;
            // R√©initialise la carte √† l'√©tat "recto"
            document.getElementById('flashcard').classList.remove('is-flipped');
            // Met √† jour le contenu
            document.getElementById('flashcard-front').textContent = card.term;
            document.getElementById('flashcard-back').textContent = card.definition;
            // Met √† jour la navigation
            ui.cardProgress.textContent = `Carte ${index + 1} / ${currentContent.flashcards.length}`;
            ui.prevCardBtn.disabled = index === 0;
            ui.nextCardBtn.disabled = index === currentContent.flashcards.length - 1;
        }

        // --- GESTION DE LA LISTE DE CONTENUS SAUVEGARD√âS ---

        // Affiche la liste des quiz et flashcards sauvegard√©s
        function renderSavedQuizzes(quizzes) {
            ui.loadingQuizzes.classList.add('hidden');
            ui.savedQuizzesList.innerHTML = '';
            if (quizzes.length === 0) {
                ui.noQuizzes.classList.remove('hidden');
            } else {
                ui.noQuizzes.classList.add('hidden');
                quizzes.forEach(quiz => {
                    const el = document.createElement('div');
                    el.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center border border-gray-700';
                    const isFlashcard = quiz.type === 'Flashcards';
                    const lastResult = quiz.lastResult ? `${quiz.lastResult.score}/${quiz.lastResult.total} (${quiz.lastResult.percentage}%)` : 'Pas encore fait';
                    const icon = isFlashcard ? 'fa-clone' : 'fa-question-circle';

                    el.innerHTML = `
                        <div class="flex items-center space-x-3 overflow-hidden">
                            <i class="fas ${icon} text-indigo-400 text-xl flex-shrink-0"></i>
                            <div class="truncate">
                                <h3 class="font-bold text-lg truncate" title="${quiz.title}">${quiz.title}</h3>
                                <p class="text-sm text-gray-400">${isFlashcard ? `${quiz.content.length} cartes` : `Dernier score: ${lastResult}`}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <button data-content='${JSON.stringify(quiz)}' class="play-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">${isFlashcard ? '√âtudier' : 'Faire'}</button>
                            <button data-id="${quiz.id}" class="delete-quiz-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-trash"></i></button>
                        </div>`;
                    
                    ui.savedQuizzesList.appendChild(el);
                });
            }
        }

        // Supprime un contenu de Firestore
        async function deleteQuiz(quizId) {
            if (window.confirm("√ätes-vous s√ªr de vouloir supprimer ce contenu ?")) {
                await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'quizzes', quizId));
                showMessage('Contenu supprim√©.', false);
            }
        }

        // --- INITIALISATION ET √âCOUTEURS D'√âV√âNEMENTS ---

        // V√©rifie l'√©tat d'authentification de l'utilisateur
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const profileData = docSnap.data();
                    document.getElementById('user-name-header').textContent = profileData.firstName;
                    document.getElementById('user-avatar-header').src = profileData.photoURL;
                    ui.navLoggedIn.classList.remove('hidden');
                    ui.navLoggedIn.classList.add('flex');
                }
                populateCourses();
                
                // √âcoute les changements en temps r√©el sur la collection de quiz
                const quizzesRef = collection(db, 'users', user.uid, 'quizzes');
                onSnapshot(quizzesRef, (snapshot) => {
                    const quizzes = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    renderSavedQuizzes(quizzes);
                });

            } else {
                window.location.href = '/login.html';
            }
        });

        // --- √âcouteurs d'√©v√©nements pour l'interactivit√© ---
        
        // Mise √† jour de la valeur du slider
        ui.questionCount.addEventListener('input', (e) => { ui.questionCountValue.textContent = e.target.value; });
        // Soumission du formulaire de g√©n√©ration
        ui.form.addEventListener('submit', generateContent);
        // Boutons de la page des r√©sultats
        ui.submitQuizBtn.addEventListener('click', submitQuiz);
        ui.restartQuizBtn.addEventListener('click', () => showSection('list'));
        ui.reviewErrorsBtn.addEventListener('click', () => displayQuiz(`R√©vision des erreurs - ${currentContent.title}`, wrongAnswers));
        ui.shareResultsBtn.addEventListener('click', () => {
            const score = ui.scoreText.textContent;
            const title = `J'ai eu ${score} √† mon quiz "${currentContent.title}" !`;
            const content = `Venez tester vos connaissances ! J'ai g√©n√©r√© ce quiz avec Projet Blocus.`;
            window.location.href = `/forum.html?shareTitle=${encodeURIComponent(title)}&shareContent=${encodeURIComponent(content)}`;
        });

        // Navigation entre les sections
        ui.goToGeneratorBtn.addEventListener('click', () => ui.contentChoiceModal.classList.remove('hidden'));
        ui.backToListBtn.addEventListener('click', () => showSection('list'));
        ui.quitQuizBtn.addEventListener('click', () => { clearInterval(timerInterval); showSection('list'); });
        
        // Modale de choix de contenu
        ui.cancelChoiceBtn.addEventListener('click', () => ui.contentChoiceModal.classList.add('hidden'));
        document.querySelectorAll('.content-choice-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                openGenerator(btn.dataset.type);
                ui.contentChoiceModal.classList.add('hidden');
            });
        });

        // Menu utilisateur
        ui.userMenuButton.addEventListener('click', (e) => { e.stopPropagation(); ui.userMenu.classList.toggle('hidden'); });
        window.addEventListener('click', (e) => { if (ui.navLoggedIn && !ui.navLoggedIn.contains(e.target)) ui.userMenu.classList.add('hidden'); });
        ui.logoutButton.addEventListener('click', async () => { await signOut(auth); window.location.href = '/index.html'; });
        
        // Options du minuteur
        ui.timerToggle.addEventListener('change', (e) => { ui.timerOptions.classList.toggle('hidden', !e.target.checked); });
        
        // Navigation dans le quiz
        ui.nextQuestionBtn.addEventListener('click', () => { saveAnswer(); showQuestion(++currentItemIndex); });
        ui.prevQuestionBtn.addEventListener('click', () => { saveAnswer(); showQuestion(--currentItemIndex); });

        // Clics sur la liste des contenus sauvegard√©s (d√©l√©gation d'√©v√©nement)
        ui.savedQuizzesList.addEventListener('click', (e) => {
            const playBtn = e.target.closest('.play-btn');
            const deleteBtn = e.target.closest('.delete-quiz-btn');

            if (playBtn) {
                const data = JSON.parse(playBtn.dataset.content);
                currentContentId = data.id;
                if (data.type === 'Flashcards') {
                    displayFlashcards(data.title, data.content);
                } else {
                    displayQuiz(data.title, data.content);
                }
            }
            if (deleteBtn) {
                deleteQuiz(deleteBtn.dataset.id);
            }
        });

        // Logique des flashcards
        ui.flipCardBtn.addEventListener('click', () => document.getElementById('flashcard').classList.toggle('is-flipped'));
        ui.nextCardBtn.addEventListener('click', () => showFlashcard(++currentItemIndex));
        ui.prevCardBtn.addEventListener('click', () => showFlashcard(--currentItemIndex));
        ui.backToListFromFlashcardsBtn.addEventListener('click', () => showSection('list'));
        
    </script>
</body>
</html>