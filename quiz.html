<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mes Quiz & Flashcards — Projet Blocus (Optimisé)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

  <!-- PDF.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    .option-label:has(input:checked){ outline:2px solid rgb(99 102 241); background-color: rgb(49 46 129 / 0.25); }
    details > summary { list-style: none; cursor: pointer; }
    details > summary::-webkit-details-marker { display: none; }

    /* Flashcards */
    .flashcard-container { perspective: 1000px; }
    .flashcard { position: relative; width: 100%; height: 300px; transform-style: preserve-3d; transition: transform .6s; }
    .flashcard.is-flipped { transform: rotateY(180deg); }
    .flashcard-face { position:absolute; inset:0; backface-visibility: hidden; display:flex; align-items:center; justify-content:center; padding:2rem; border-radius: .75rem; border:1px solid rgb(55 65 81); }
    .flashcard-front { background:#111827; }
    .flashcard-back { background:#4f46e5; transform: rotateY(180deg); }

    /* Loader */
    .spinner { width: 56px; height:56px; border-radius: 9999px; border:6px solid rgba(129,140,248,.25); border-top-color:#6366f1; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-20 bg-gray-900/80 backdrop-blur border-b border-gray-800">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="#" class="flex items-center gap-3">
        <img src="https://placehold.co/48x48/111827/ffffff?text=PB" alt="Logo" class="h-10 w-10 rounded-lg shadow" />
        <span class="text-xl font-extrabold">Projet Blocus</span>
      </a>

      <div class="flex items-center gap-2 text-sm text-gray-300">
        <label class="px-3 py-1 rounded bg-gray-800 border border-gray-700 cursor-pointer hover:bg-gray-700">
          <i class="fa-solid fa-file-arrow-up mr-2"></i> Importer PDF(s)
          <input id="pdf-input" type="file" accept="application/pdf" multiple class="hidden">
        </label>

        <button id="open-generator" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-700 font-semibold">
          <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Nouveau contenu
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto px-4 py-8 space-y-10">

    <!-- Liste -->
    <section id="list-section">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-extrabold">Mes Quiz & Flashcards</h1>
      </div>

      <div id="loading-quizzes" class="hidden flex flex-col items-center justify-center py-16">
        <div class="spinner"></div>
        <p class="text-gray-400 mt-4">Chargement…</p>
      </div>

      <div id="no-quizzes" class="hidden text-center py-16 border border-dashed border-gray-700 rounded-xl">
        <i class="fa-regular fa-rectangle-list text-5xl text-gray-500 mb-4"></i>
        <h3 class="text-xl font-bold">Aucun contenu</h3>
        <p class="text-gray-400 mt-1">Crée ton premier quiz ou jeu de flashcards.</p>
      </div>

      <div id="saved-list" class="grid md:grid-cols-2 gap-4"></div>
    </section>

    <!-- Generator -->
    <section id="generator-section" class="hidden">
      <button id="back-to-list" class="text-indigo-400 hover:text-indigo-300 mb-6">
        <i class="fa-solid fa-arrow-left mr-2"></i>Retour à la liste
      </button>

      <h2 class="text-2xl font-bold mb-2">Générateur de contenu (Local, sans API)</h2>
      <p class="text-gray-400 mb-6">Colle du texte ou importe des PDF, choisis le type et génère.</p>

      <form id="generator-form" class="bg-gray-800 rounded-xl border border-gray-700 p-6 space-y-6">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-2 font-semibold">Titre</label>
            <input id="gen-title" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3" placeholder="Ex: Révision Chapitre 1" required>
          </div>
          <div>
            <label class="block mb-2 font-semibold">Type</label>
            <select id="gen-type" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3">
              <option value="QCM">Quiz — QCM</option>
              <option value="Vrai/Faux">Quiz — Vrai/Faux</option>
              <option value="Réponse Courte">Quiz — Réponse courte</option>
              <option value="Texte à trous">Quiz — Texte à trous</option>
              <option value="Flashcards">Flashcards</option>
            </select>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-2 font-semibold">Nombre d'éléments</label>
            <input id="gen-count" type="range" min="5" max="50" value="10" class="w-full">
            <div class="text-right"><span id="gen-count-value" class="text-indigo-400 font-bold">10</span></div>
          </div>
          <div>
            <label class="block mb-2 font-semibold">Difficulté</label>
            <select id="gen-difficulty" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3">
              <option>Facile</option>
              <option selected>Moyen</option>
              <option>Difficile</option>
            </select>
          </div>
          <div>
            <label class="block mb-2 font-semibold">Minuteur</label>
            <div class="flex items-center gap-2">
              <input id="timer-enabled" type="checkbox" class="h-5 w-5">
              <span>Activer</span>
            </div>
            <div id="timer-config" class="mt-3 hidden space-y-2">
              <div class="flex items-center gap-2">
                <input type="radio" name="timer-type" id="timer-global" value="global" checked>
                <label for="timer-global">Global (min)</label>
                <input id="timer-global-value" type="number" min="1" value="10" class="ml-3 w-20 bg-gray-900 border border-gray-700 rounded px-2 py-1">
              </div>
              <div class="flex items-center gap-2">
                <input type="radio" name="timer-type" id="timer-perq" value="perq">
                <label for="timer-perq">Par question (sec)</label>
                <input id="timer-perq-value" type="number" min="5" value="30" class="ml-3 w-20 bg-gray-900 border border-gray-700 rounded px-2 py-1">
              </div>
            </div>
          </div>
        </div>

        <div>
          <label class="block mb-2 font-semibold">Instruction (optionnel)</label>
          <textarea id="gen-instruction" rows="2" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3" placeholder="Ex: insiste sur les dates clés…"></textarea>
        </div>

        <div>
          <label class="block mb-2 font-semibold">Texte source</label>
          <textarea id="gen-text" rows="8" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3" placeholder="Colle ici du texte…"></textarea>
          <p class="text-xs text-gray-400 mt-2">Astuce : tu peux aussi importer des PDF en haut à droite, ils seront concaténés ici.</p>
        </div>

        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 font-bold py-3 rounded-lg">
          <i class="fa-solid fa-bolt mr-2"></i>Générer
        </button>
      </form>
    </section>

    <!-- Prise de quiz -->
    <section id="taking-section" class="hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 id="take-title" class="text-2xl font-bold"></h2>
        <div id="timer-display" class="hidden text-2xl font-extrabold text-indigo-400"></div>
      </div>

      <div id="q-timer-bar-wrap" class="hidden w-full bg-gray-800 rounded-full h-2.5 mb-4">
        <div id="q-timer-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width:0%"></div>
      </div>

      <div id="question-wrap"></div>

      <div class="flex justify-between items-center mt-8">
        <button id="quit-quiz" class="bg-red-600 hover:bg-red-700 font-bold px-4 py-2 rounded-lg">Quitter</button>
        <span id="q-progress" class="text-sm text-gray-300"></span>
        <div>
          <button id="prev-q" class="bg-gray-700 hover:bg-gray-600 font-bold px-4 py-2 rounded-lg disabled:opacity-50" disabled>Précédent</button>
          <button id="next-q" class="bg-indigo-600 hover:bg-indigo-700 font-bold px-4 py-2 rounded-lg ml-2">Suivant</button>
        </div>
      </div>

      <button id="submit-quiz" class="hidden mt-8 w-full bg-green-600 hover:bg-green-700 font-bold px-4 py-3 rounded-lg">Terminer</button>
    </section>

    <!-- Résultats -->
    <section id="results-section" class="hidden text-center">
      <h2 class="text-3xl font-extrabold mb-2">Résultats</h2>
      <p id="results-sub" class="text-gray-400 mb-6"></p>
      <div class="bg-gray-800 border border-gray-700 rounded-xl p-6">
        <p class="text-xl font-semibold">Votre score</p>
        <p id="score-text" class="text-6xl font-extrabold text-indigo-400 my-3">0/0</p>
        <p id="score-pct" class="text-xl font-bold text-green-400"></p>
        <div class="mt-6 flex justify-center gap-3">
          <button id="back-home" class="bg-indigo-600 hover:bg-indigo-700 font-bold px-5 py-2 rounded-lg">Retour à la liste</button>
          <button id="review-errors" class="bg-yellow-500 hover:bg-yellow-600 font-bold px-5 py-2 rounded-lg">Réviser mes erreurs</button>
        </div>
        <div id="results-list" class="text-left mt-6 space-y-3"></div>
      </div>
    </section>

    <!-- Flashcards -->
    <section id="flashcards-section" class="hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 id="fc-title" class="text-2xl font-bold"></h2>
        <button id="fc-back" class="text-indigo-400 hover:text-indigo-300 font-semibold">Retour à la liste</button>
      </div>

      <div class="flashcard-container">
        <div id="flashcard" class="flashcard">
          <div id="fc-front" class="flashcard-face flashcard-front text-2xl font-bold"></div>
          <div id="fc-backside" class="flashcard-face flashcard-back text-lg"></div>
        </div>
      </div>

      <div class="mt-6 flex justify-center">
        <button id="fc-flip" class="bg-gray-700 hover:bg-gray-600 font-bold px-6 py-2 rounded-lg">Retourner</button>
      </div>

      <div class="flex items-center justify-between mt-8">
        <button id="fc-prev" class="bg-indigo-600 hover:bg-indigo-700 font-bold px-6 py-2 rounded-lg disabled:opacity-50" disabled>Précédent</button>
        <span id="fc-progress" class="text-sm text-gray-300"></span>
        <button id="fc-next" class="bg-indigo-600 hover:bg-indigo-700 font-bold px-6 py-2 rounded-lg">Suivant</button>
      </div>
    </section>

    <!-- Loader global -->
    <div id="global-loader" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
      <div class="bg-gray-900 border border-gray-700 rounded-xl p-8 flex flex-col items-center">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-300">Traitement en cours…</p>
      </div>
    </div>

    <!-- Messages -->
    <div id="toast" class="fixed bottom-4 right-4 z-50"></div>

  </main>

  <script>
    // ======================
    // Utils
    // ======================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const show = (el, yes=true) => el?.classList.toggle('hidden', !yes);
    const text = (el, t='') => el && (el.textContent = t);
    const html = (el, h='') => el && (el.innerHTML = h);
    const byId = id => document.getElementById(id);

    const toast = (msg, ok=true) => {
      const box = document.createElement('div');
      box.className = `px-4 py-3 rounded-lg shadow-lg mb-2 ${ok?'bg-green-600':'bg-red-600'}`;
      box.textContent = msg;
      byId('toast').appendChild(box);
      setTimeout(()=> box.remove(), 3500);
    };

    const loader = {
      show(){ show(byId('global-loader'), true); },
      hide(){ show(byId('global-loader'), false); }
    };

    const STORAGE = {
      KEY: 'pb_contents_v1',
      all(){
        try { return JSON.parse(localStorage.getItem(this.KEY) || '[]'); }
        catch{ return []; }
      },
      saveAll(list){ localStorage.setItem(this.KEY, JSON.stringify(list)); },
      add(item){
        const list = this.all();
        list.unshift(item);
        this.saveAll(list);
      },
      remove(id){
        const list = this.all().filter(x => x.id !== id);
        this.saveAll(list);
      }
    };

    const UID = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    // ======================
    // PDF Extraction (local)
    // ======================
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    async function extractTextFromPDF(file){
      const arrayBuf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arrayBuf}).promise;
      let full = '';
      for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const tc = await page.getTextContent();
        full += tc.items.map(it=>it.str).join(' ') + '\n';
      }
      return full;
    }

    // ======================
    // Simple Local Generators (no API)
    // ======================
    function pick(arr, n){
      const a = [...arr];
      const out = [];
      while(out.length < Math.min(n, a.length)){
        const idx = Math.floor(Math.random()*a.length);
        out.push(a.splice(idx,1)[0]);
      }
      return out;
    }

    function sentencesFrom(text){
      return text
        .replace(/\s+/g,' ')
        .split(/(?<=[.!?])\s+/)
        .map(s => s.trim())
        .filter(s => s.length > 30);
    }

    function keywords(text, n=30){
      const stop = new Set("le la les de des du un une et ou mais donc or ni car à au aux en dans sur sous chez par pour avec sans entre vers versus selon selon que qui quoi dont où comme si se sa son ses ce cet cette ces leur leurs ne pas plus moins très aussi afin ainsi encore déjà tout toute tous toutes lorsque tandis pendant avant après contre".split(/\s+/));
      const words = text.toLowerCase().match(/[a-zàâçéèêëîïôûùüÿœ'-]{3,}/g) || [];
      const freq = new Map();
      for(const w of words){ if(!stop.has(w)) freq.set(w,(freq.get(w)||0)+1); }
      return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n).map(([w])=>w);
    }

    function generateFlashcardsLocal(text, count){
      const sents = sentencesFrom(text);
      const keys = keywords(text, Math.max(count*3, 30));
      const cards = [];
      for(let i=0;i<count;i++){
        const term = (keys[i] || `Concept ${i+1}`).replace(/^./, c=>c.toUpperCase());
        const sentence = sents[i % sents.length] || "Définition à partir du contexte du cours.";
        const def = sentence.length > 160 ? sentence.slice(0,160) + '…' : sentence;
        cards.push({ term, definition: def });
      }
      return cards;
    }

    function generateQuizLocal(text, count, type){
      const sents = sentencesFrom(text);
      const keys = keywords(text, Math.max(count*4, 40));
      const quiz = [];

      for(let i=0;i<count;i++){
        const base = sents[i % sents.length] || "Le cours indique un fait important à retenir.";
        let q = { question:'', options:null, answer:'', explanation:'' };

        if(type === 'QCM'){
          const key = (keys[i] || 'connaissance');
          const blank = base.replace(new RegExp(`\\b${key}\\b`,'i'), '_____');
          q.question = blank.includes('_____') ? `Complète : ${blank}` : `À propos : ${key}`;
          const correct = key;
          const distractors = pick(keys.filter(k=>k!==key), 3);
          q.options = pick([correct, ...distractors], 4);
          q.answer = correct;
          q.explanation = `La bonne réponse est « ${correct} » d'après le contenu du cours.`;

        } else if(type === 'Vrai/Faux'){
          const isTrue = Math.random() > 0.5;
          q.question = base;
          q.options = ['Vrai','Faux'];
          q.answer = isTrue ? 'Vrai' : 'Faux';
          q.explanation = isTrue ? 'Énoncé conforme au cours.' : 'Énoncé altéré pour le piège.';
        } else if(type === 'Réponse Courte'){
          const key = (keys[i] || 'concept');
          q.question = `Définis brièvement : « ${key} »`;
          q.options = null;
          q.answer = key;
          q.explanation = `Mot-clé attendu : « ${key} ».`;
        } else { // Texte à trous
          const key = (keys[i] || 'concept');
          const cloze = base.replace(new RegExp(`\\b${key}\\b`,'i'), '[BLANK]');
          q.question = cloze.includes('[BLANK]') ? cloze : `${base} → Remplace un mot clé par [BLANK]`;
          q.options = null;
          q.answer = key;
          q.explanation = `Le mot manquant est « ${key} ».`;
        }
        quiz.push(q);
      }
      return quiz;
    }

    // ======================
    // State
    // ======================
    const UI = {
      list: byId('list-section'),
      generator: byId('generator-section'),
      taking: byId('taking-section'),
      results: byId('results-section'),
      flashcards: byId('flashcards-section'),

      savedList: byId('saved-list'),
      noQuizzes: byId('no-quizzes'),
      loadingQuizzes: byId('loading-quizzes'),

      openGen: byId('open-generator'),
      backToList: byId('back-to-list'),

      genForm: byId('generator-form'),
      genTitle: byId('gen-title'),
      genType: byId('gen-type'),
      genCount: byId('gen-count'),
      genCountValue: byId('gen-count-value'),
      genDiff: byId('gen-difficulty'),
      genInstr: byId('gen-instruction'),
      genText: byId('gen-text'),

      timerEnabled: byId('timer-enabled'),
      timerConfig: byId('timer-config'),
      timerGlobal: byId('timer-global'),
      timerGlobalVal: byId('timer-global-value'),
      timerPerQ: byId('timer-perq'),
      timerPerQVal: byId('timer-perq-value'),

      pdfInput: byId('pdf-input'),

      // taking
      takeTitle: byId('take-title'),
      qWrap: byId('question-wrap'),
      qProgress: byId('q-progress'),
      prevQ: byId('prev-q'),
      nextQ: byId('next-q'),
      submitQuiz: byId('submit-quiz'),
      quitQuiz: byId('quit-quiz'),
      timerDisplay: byId('timer-display'),
      qTimerBarWrap: byId('q-timer-bar-wrap'),
      qTimerBar: byId('q-timer-bar'),

      // results
      resultsSub: byId('results-sub'),
      scoreText: byId('score-text'),
      scorePct: byId('score-pct'),
      resultsList: byId('results-list'),
      backHome: byId('back-home'),
      reviewErrors: byId('review-errors'),

      // flashcards
      fcTitle: byId('fc-title'),
      fcCard: byId('flashcard'),
      fcFront: byId('fc-front'),
      fcBack: byId('fc-backside'),
      fcFlip: byId('fc-flip'),
      fcPrev: byId('fc-prev'),
      fcNext: byId('fc-next'),
      fcProgress: byId('fc-progress'),
      fcBackBtn: byId('fc-back'),
    };

    let current = {
      mode: null,            // 'quiz' | 'flashcards'
      title: '',
      quiz: null,            // {questions:[], timer:{type:'global'|'perq', value:number}|null}
      flashcards: null,      // []
      answers: [],
      wrong: [],
      idx: 0,
      timer: null,
      timeLeft: 0,
      perQTotal: 0,
      savedId: null
    };

    function resetCurrent(){
      current = {
        mode: null, title:'', quiz:null, flashcards:null, answers:[], wrong:[], idx:0,
        timer: null, timeLeft:0, perQTotal:0, savedId:null
      };
    }

    // ======================
    // Render: Saved list
    // ======================
    function renderSaved(){
      const items = STORAGE.all();
      show(UI.loadingQuizzes, false);

      if(!items.length){
        show(UI.noQuizzes, true);
        html(UI.savedList, '');
        return;
      }
      show(UI.noQuizzes, false);

      html(UI.savedList, items.map(item => {
        const isFlash = item.type === 'Flashcards';
        const stat = isFlash ? `${item.content.length} cartes`
                             : (item.lastResult ? `${item.lastResult.score}/${item.lastResult.total} (${item.lastResult.pct}%)` : 'Pas encore fait');
        const icon = isFlash ? 'fa-clone' : 'fa-circle-question';
        return `
          <div class="p-4 rounded-xl border border-gray-800 bg-gray-900 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="fa-solid ${icon} text-indigo-400 text-xl"></i>
              <div>
                <div class="font-bold">${escapeHtml(item.title)}</div>
                <div class="text-sm text-gray-400">${isFlash ? stat : `Dernier score : ${stat}`}</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-700 font-semibold" data-action="open" data-id="${item.id}">
                ${isFlash ? 'Étudier' : 'Faire'}
              </button>
              <button class="px-3 py-1 rounded bg-red-600 hover:bg-red-700" data-action="del" data-id="${item.id}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join(''));
    }

    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // ======================
    // Navigation (Sections)
    // ======================
    function go(section){
      show(UI.list, section==='list');
      show(UI.generator, section==='generator');
      show(UI.taking, section==='taking');
      show(UI.results, section==='results');
      show(UI.flashcards, section==='flashcards');
    }

    // ======================
    // Quiz taking
    // ======================
    function startQuizFlow(title, questions, timerCfg, savedId=null){
      resetCurrent();
      current.mode = 'quiz';
      current.title = title;
      current.quiz = { questions, timer: timerCfg || null };
      current.answers = new Array(questions.length).fill(null);
      current.idx = 0;
      current.savedId = savedId || null;

      text(UI.takeTitle, title);
      renderQuestion(0);
      startTimerIfAny();
      go('taking');
    }

    function renderQuestion(i){
      const q = current.quiz.questions[i];
      current.idx = i;

      const optionsHtml = q.options?.length
        ? q.options.map(opt => {
            const checked = current.answers[i] === opt ? 'checked' : '';
            return `
              <label class="option-label block bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 cursor-pointer hover:bg-gray-800/70">
                <input class="hidden" type="radio" name="qi${i}" value="${escapeHtml(opt)}" ${checked}>
                <span>${escapeHtml(opt)}</span>
              </label>
            `;
          }).join('')
        : `<input type="text" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3" placeholder="Votre réponse…" value="${escapeHtml(current.answers[i]||'')}">`;

      html(UI.qWrap, `
        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
          <p class="text-lg font-bold mb-4">${i+1}. ${escapeHtml(q.question)}</p>
          <div class="space-y-3">${optionsHtml}</div>
        </div>
      `);

      // bind input save
      if(q.options?.length){
        $$('#question-wrap input[type="radio"]').forEach(inp => {
          inp.addEventListener('change', () => current.answers[i] = inp.value);
        });
      } else {
        $('#question-wrap input[type="text"]').addEventListener('input', e => current.answers[i] = e.target.value);
      }

      text(UI.qProgress, `Question ${i+1} / ${current.quiz.questions.length}`);
      UI.prevQ.disabled = i === 0;
      show(UI.nextQ, i < current.quiz.questions.length - 1);
      show(UI.submitQuiz, i === current.quiz.questions.length - 1);
    }

    function startTimerIfAny(){
      clearInterval(current.timer);
      show(UI.timerDisplay, false);
      show(UI.qTimerBarWrap, false);

      const t = current.quiz.timer;
      if(!t) return;

      if(t.type === 'global'){
        current.timeLeft = t.value * 60;
        show(UI.timerDisplay, true);
        current.timer = setInterval(()=>{
          current.timeLeft--;
          const m = Math.max(0, Math.floor(current.timeLeft/60));
          const s = Math.max(0, current.timeLeft % 60);
          text(UI.timerDisplay, `${m}:${String(s).padStart(2,'0')}`);
          if(current.timeLeft<=0){ clearInterval(current.timer); finishQuiz(); }
        }, 1000);
      } else {
        current.perQTotal = t.value;
        show(UI.qTimerBarWrap, true);
        current.timeLeft = t.value;
        updatePerQBar();
        current.timer = setInterval(()=>{
          current.timeLeft--;
          updatePerQBar();
          if(current.timeLeft<=0){
            // auto next or finish
            if(current.idx < current.quiz.questions.length - 1){
              renderQuestion(current.idx+1);
              current.timeLeft = current.perQTotal;
              updatePerQBar();
            } else {
              clearInterval(current.timer);
              finishQuiz();
            }
          }
        }, 1000);
      }
    }

    function updatePerQBar(){
      const pct = Math.max(0, Math.min(100, (current.timeLeft/current.perQTotal)*100));
      UI.qTimerBar.style.width = pct + '%';
    }

    function finishQuiz(){
      clearInterval(current.timer);
      // grade
      let score = 0;
      const wrong = [];
      current.quiz.questions.forEach((q, i) => {
        const ans = (current.answers[i] || '').trim().toLowerCase();
        const correct = (q.answer || '').trim().toLowerCase();
        const ok = ans === correct || (q.options?.length && ans === correct);
        if(ok) score++; else wrong.push({ ...q, your: current.answers[i] || '' });
      });
      current.wrong = wrong;

      const total = current.quiz.questions.length;
      const pct = Math.round((score/total)*100);

      text(UI.resultsSub, `Résultats pour : ${current.title}`);
      text(UI.scoreText, `${score}/${total}`);
      text(UI.scorePct, `${pct}% de bonnes réponses`);
      html(UI.resultsList, current.quiz.questions.map((q, idx) => {
        const your = current.answers[idx] || 'Aucune';
        const isOk = (your.trim().toLowerCase() === (q.answer||'').trim().toLowerCase());
        return `
          <details class="border rounded-lg ${isOk?'border-green-700 bg-green-900/20':'border-red-700 bg-red-900/20'} p-4">
            <summary class="flex items-center justify-between">
              <span class="font-semibold">${idx+1}. ${escapeHtml(q.question)}</span>
              <i class="fa-solid fa-chevron-down ml-4"></i>
            </summary>
            <div class="mt-3 pt-3 border-t border-gray-700 text-sm">
              <p>Votre réponse : <span class="${isOk?'text-green-300':'text-red-300'}">${escapeHtml(your)}</span></p>
              ${!isOk ? `<p>Réponse correcte : <span class="text-green-300">${escapeHtml(q.answer||'')}</span></p>` : ''}
              ${q.explanation ? `<p class="text-gray-300 mt-2"><em>${escapeHtml(q.explanation)}</em></p>` : ''}
            </div>
          </details>
        `;
      }).join(''));

      // persist last result if saved
      if(current.savedId){
        const all = STORAGE.all();
        const idx = all.findIndex(x => x.id === current.savedId);
        if(idx !== -1){
          all[idx].lastResult = { score, total, pct, at: Date.now() };
          STORAGE.saveAll(all);
        }
      }

      go('results');
    }

    // ======================
    // Flashcards study
    // ======================
    function startFlashcardsFlow(title, cards){
      resetCurrent();
      current.mode = 'flashcards';
      current.title = title;
      current.flashcards = cards;
      current.idx = 0;

      text(UI.fcTitle, title);
      renderFlashcard(0);
      go('flashcards');
    }

    function renderFlashcard(i){
      const card = current.flashcards[i];
      current.idx = i;
      UI.fcCard.classList.remove('is-flipped');
      text(UI.fcFront, card.term);
      text(UI.fcBack, card.definition);
      text(UI.fcProgress, `Carte ${i+1} / ${current.flashcards.length}`);
      UI.fcPrev.disabled = i === 0;
      UI.fcNext.disabled = i === current.flashcards.length - 1;
    }

    // ======================
    // Generator submit
    // ======================
    UI.genCount.addEventListener('input', e => text(UI.genCountValue, e.target.value));
    UI.timerEnabled.addEventListener('change', e => show(UI.timerConfig, e.target.checked));

    UI.genForm.addEventListener('submit', async e => {
      e.preventDefault();
      const title = UI.genTitle.value.trim();
      const type = UI.genType.value;
      const count = parseInt(UI.genCount.value, 10);
      const diff = UI.genDiff.value;
      const instr = UI.genInstr.value.trim();
      let source = UI.genText.value.trim();

      if(!title){ toast('Ajoute un titre.', false); return; }
      if(source.length < 20){ toast('Ajoute du texte source (ou importe des PDF).', false); return; }

      loader.show();
      try{
        let content;
        if(type === 'Flashcards'){
          const flashcards = generateFlashcardsLocal(source, count);
          content = { type, title, content: flashcards };
          STORAGE.add({ id: UID(), ...content });
          toast('Flashcards générées ✅');
          renderSaved();
          startFlashcardsFlow(title, flashcards);
        }else{
          const questions = generateQuizLocal(source, count, type);
          // build timer cfg if any
          let timerCfg = null;
          if(UI.timerEnabled.checked){
            if(UI.timerGlobal.checked) timerCfg = { type:'global', value: parseInt(UI.timerGlobalVal.value||'10',10) };
            else timerCfg = { type:'perq', value: parseInt(UI.timerPerQVal.value||'30',10) };
          }
          const savedId = UID();
          STORAGE.add({ id: savedId, type, title, content: questions, timer: timerCfg, lastResult:null });
          toast('Quiz généré ✅');
          renderSaved();
          startQuizFlow(title, questions, timerCfg, savedId);
        }
      } catch(err){
        console.error(err);
        toast('Erreur pendant la génération.', false);
      } finally {
        loader.hide();
      }
    });

    // ======================
    // Saved list interactions
    // ======================
    UI.savedList.addEventListener('click', e => {
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if(action === 'del'){
        const ok = confirm('Supprimer ce contenu ?');
        if(!ok) return;
        STORAGE.remove(id);
        renderSaved();
        toast('Supprimé.');
      } else if(action === 'open'){
        const item = STORAGE.all().find(x => x.id === id);
        if(!item) return;
        if(item.type === 'Flashcards'){
          startFlashcardsFlow(item.title, item.content);
        } else {
          startQuizFlow(item.title, item.content, item.timer || null, item.id);
        }
      }
    });

    // ======================
    // Controls (Taking)
    // ======================
    UI.prevQ.addEventListener('click', () => {
      if(current.idx > 0){
        renderQuestion(current.idx - 1);
        if(current.quiz.timer?.type === 'perq'){ current.timeLeft = current.perQTotal; updatePerQBar(); }
      }
    });
    UI.nextQ.addEventListener('click', () => {
      if(current.idx < current.quiz.questions.length - 1){
        renderQuestion(current.idx + 1);
        if(current.quiz.timer?.type === 'perq'){ current.timeLeft = current.perQTotal; updatePerQBar(); }
      }
    });
    UI.submitQuiz.addEventListener('click', finishQuiz);
    UI.quitQuiz.addEventListener('click', () => { clearInterval(current.timer); go('list'); });

    UI.backHome.addEventListener('click', () => { go('list'); });
    UI.reviewErrors.addEventListener('click', () => {
      if(!current.wrong.length){ toast('Aucune erreur à réviser 🎉'); return; }
      startQuizFlow(`Révision — ${current.title}`, current.wrong, current.quiz.timer);
    });

    // ======================
    // Controls (Flashcards)
    // ======================
    UI.fcFlip.addEventListener('click', () => UI.fcCard.classList.toggle('is-flipped'));
    UI.fcPrev.addEventListener('click', () => { if(current.idx>0) renderFlashcard(current.idx-1); });
    UI.fcNext.addEventListener('click', () => { if(current.idx<current.flashcards.length-1) renderFlashcard(current.idx+1); });
    UI.fcBackBtn.addEventListener('click', () => go('list'));

    // ======================
    // Navigation
    // ======================
    UI.openGen.addEventListener('click', () => { go('generator'); });
    UI.backToList.addEventListener('click', () => { go('list'); });

    // ======================
    // PDF import → append to textarea
    // ======================
    UI.pdfInput.addEventListener('change', async e => {
      const files = Array.from(e.target.files || []);
      if(!files.length) return;
      loader.show();
      try{
        const texts = [];
        for(const f of files){
          const t = await extractTextFromPDF(f);
          texts.push(`--- ${f.name} ---\n` + t);
        }
        const joined = texts.join('\n\n');
        UI.genText.value = (UI.genText.value.trim() + '\n\n' + joined).trim();
        toast('PDF importé et ajouté au texte source ✅');
        go('generator');
      } catch(err){
        console.error(err);
        toast('Échec de l\'import PDF.', false);
      } finally {
        loader.hide();
        e.target.value = '';
      }
    });

    // ======================
    // Init
    // ======================
    (function init(){
      renderSaved();
      go('list');
      text(UI.genCountValue, UI.genCount.value);
    })();
  </script>
</body>
</html>
