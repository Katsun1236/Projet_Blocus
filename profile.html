<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Projet Blocus</title>
    <link rel="icon" type="image/png" href="images/logo.png" onerror="this.onerror=null;this.src='https://firebasestorage.googleapis.com/v0/b/chatbot-playground-c0c32.appspot.com/o/opera_xnPtx6KH7F.png?alt=media&token=c191a3ec-80f0-466d-9788-b7f33d79047c';">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .badge { transition: all 0.3s ease; cursor: pointer; }
        .badge.locked { filter: grayscale(100%); opacity: 0.5; }
        .badge:not(.locked):hover { transform: scale(1.1); }
        .filter-btn.active { background-color: #4f46e5; color: white; }
        #badges-wrapper {
            max-height: 120px; /* Hauteur d'une rang√©e environ */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        #badges-wrapper.expanded {
            max-height: 1000px; /* Assez grand pour tout montrer */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <header class="flex justify-between items-center p-6 bg-gray-900 shadow-lg w-full z-20 sticky top-0">
        <a href="/dashboard.html" class="flex items-center space-x-2">
            <img src="images/logo.png" onerror="this.onerror=null;this.src='https://firebasestorage.googleapis.com/v0/b/chatbot-playground-c0c32.appspot.com/o/opera_xnPtx6KH7F.png?alt=media&token=c191a3ec-80f0-466d-9788-b7f33d79047c';" alt="Logo Projet Blocus" class="h-10">
        </a>
        <nav id="nav-logged-in" class="hidden items-center relative">
            <button id="user-menu-button" class="flex items-center space-x-3 text-white hover:text-indigo-400 transition-colors duration-300">
                <img id="user-avatar-header" src="https://placehold.co/32x32/4b5563/ffffff?text=üë§" class="h-8 w-8 rounded-full object-cover border-2 border-indigo-500">
                <span id="user-name-header" class="font-semibold">Chargement...</span>
                <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div id="user-menu" class="hidden absolute top-12 right-0 bg-gray-800 rounded-lg shadow-xl w-48 py-2 border border-gray-700">
                <a href="/dashboard.html" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">Tableau de Bord</a>
                <a href="/profile.html" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">Mon Profil</a>
                <hr class="border-gray-600 my-2">
                <button id="logout-button" class="w-full text-left px-4 py-2 text-red-400 hover:bg-red-500 hover:text-white">Se d√©connecter</button>
            </div>
        </nav>
    </header>

    <main class="w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="loading-profile" class="text-center p-12">
            <i class="fas fa-spinner fa-spin text-indigo-400 text-5xl"></i>
            <p class="mt-4 text-gray-400 text-lg">Chargement du profil...</p>
        </div>

        <div id="profile-content" class="hidden">
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full border border-gray-700 mb-8">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center mb-4 md:mb-0 text-center md:text-left">
                        <img id="profile-picture-display" src="" alt="Photo de profil" class="w-24 h-24 rounded-full border-4 border-indigo-500 object-cover">
                        <div class="ml-6">
                            <h1 id="user-name" class="text-3xl font-bold"></h1>
                            <p id="user-school" class="text-gray-400"></p>
                            <p id="user-email" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 flex items-center space-x-4">
                    <i class="fas fa-file-alt text-4xl text-indigo-400"></i>
                    <div><p class="text-gray-400">Cours Upload√©s</p><p id="stats-courses" class="text-2xl font-bold">0</p></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 flex items-center space-x-4">
                    <i class="fas fa-clipboard-question text-4xl text-green-400"></i>
                    <div><p class="text-gray-400">Quiz Cr√©√©s</p><p id="stats-quizzes" class="text-2xl font-bold">0</p></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 flex items-center space-x-4">
                    <i class="fas fa-folder text-4xl text-yellow-400"></i>
                    <div><p class="text-gray-400">Dossiers Cr√©√©s</p><p id="stats-folders" class="text-2xl font-bold">0</p></div>
                </div>
            </div>

            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full border border-gray-700 mb-8">
                <h2 class="text-2xl font-bold mb-6">Succ√®s</h2>
                <div id="badges-wrapper">
                    <div id="badges-container" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-6 text-center"></div>
                </div>
                <div class="text-center mt-4">
                    <button id="toggle-badges-btn" class="text-indigo-400 hover:text-indigo-300 font-semibold">
                        Voir plus <i class="fas fa-chevron-down ml-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full border border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <h2 class="text-2xl font-bold mb-4 sm:mb-0">Activit√©</h2>
                    <div class="flex flex-wrap gap-2">
                        <div id="activity-type-filters" class="flex space-x-1 bg-gray-700 rounded-lg p-1">
                             <button data-type="courses" class="filter-btn activity-btn active px-3 py-1 rounded-md text-sm font-semibold">Cours</button>
                             <button data-type="quizzes" class="filter-btn activity-btn px-3 py-1 rounded-md text-sm font-semibold text-gray-300">Quiz</button>
                             <button data-type="folders" class="filter-btn activity-btn px-3 py-1 rounded-md text-sm font-semibold text-gray-300">Dossiers</button>
                        </div>
                        <div id="chart-period-filters" class="flex space-x-1 bg-gray-700 rounded-lg p-1">
                            <button data-period="7" class="filter-btn period-btn active px-3 py-1 rounded-md text-sm font-semibold">7 j</button>
                            <button data-period="30" class="filter-btn period-btn px-3 py-1 rounded-md text-sm font-semibold text-gray-300">30 j</button>
                        </div>
                    </div>
                </div>
                <canvas id="activity-chart"></canvas>
            </div>
        </div>
    </main>

    <div id="badge-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-8 shadow-xl w-full max-w-md text-center border border-gray-600">
            <div id="badge-modal-icon" class="bg-gray-700 w-24 h-24 rounded-full flex items-center justify-center mx-auto border-4 border-indigo-500 mb-4">
                <i class="fas fa-question text-4xl text-yellow-400"></i>
            </div>
            <h2 id="badge-modal-title" class="text-2xl font-bold mb-2">Titre du Succ√®s</h2>
            <p id="badge-modal-description" class="text-gray-400 mb-6">Description de comment d√©bloquer ce succ√®s.</p>
            <div id="badge-modal-progress-container" class="hidden w-full bg-gray-700 rounded-full h-4 mb-2">
                <div id="badge-modal-progress-bar" class="bg-green-500 h-4 rounded-full text-xs text-white flex items-center justify-center" style="width: 0%;"></div>
            </div>
            <p id="badge-modal-progress-text" class="text-sm text-gray-300 mb-6"></p>
            <button id="close-badge-modal" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">Fermer</button>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const allBadges = {
            'course1': { title: 'Premiers Pas', desc: 'Uploader son premier cours.', icon: 'fa-graduation-cap', goal: 1, type: 'courses' },
            'connect7': { title: 'Habitu√©(e) du Campus', desc: 'Se connecter 7 jours d\'affil√©e.', icon: 'fa-calendar-check', goal: 7, type: 'logins' },
            'night-owl': { title: 'Oiseau de Nuit', desc: 'Lancer une session d\'√©tude apr√®s minuit.', icon: 'fa-moon', goal: 1, type: 'sessions' },
            'early-bird': { title: 'L√®ve-t√¥t', desc: 'Lancer une session d\'√©tude avant 7h du matin.', icon: 'fa-sun', goal: 1, type: 'sessions' },
            'marathon': { title: 'Marathonien(ne)', desc: 'Utiliser l\'application pendant plus de 3 heures.', icon: 'fa-running', goal: 1, type: 'sessions' },
            'explorer': { title: 'Explorateur', desc: 'Utiliser le Quiz, la Synth√®se et le Forum.', icon: 'fa-map-signs', goal: 3, type: 'features' },
            'perfect10': { title: 'Le 10/10', desc: 'Obtenir 100% √† un quiz d\'au moins 10 questions.', icon: 'fa-star', goal: 1, type: 'scores' },
            'streak5': { title: 'Cerveau en √©bullition', desc: 'R√©ussir 5 quiz d\'affil√©e (+80%).', icon: 'fa-fire', goal: 5, type: 'streaks' },
            'time-master': { title: 'Ma√Ætre du Temps', desc: 'Terminer un quiz avec plus de la moiti√© du temps restant.', icon: 'fa-stopwatch', goal: 1, type: 'timers' },
            'qcm-king': { title: 'Roi / Reine du QCM', desc: 'R√©pondre correctement √† 100 QCM.', icon: 'fa-crown', goal: 100, type: 'qcmAnswers' },
            'short-answer-pro': { title: 'Pr√©cision Chirurgicale', desc: 'Obtenir 100% √† un quiz "R√©ponse courte".', icon: 'fa-bullseye', goal: 1, type: 'scores' },
            'course5': { title: 'Biblioth√©caire', desc: 'Uploader 5 cours.', icon: 'fa-book-reader', goal: 5, type: 'courses' },
            'folder1': { title: 'Architecte du Savoir', desc: 'Cr√©er son premier dossier.', icon: 'fa-folder-plus', goal: 1, type: 'folders' },
            'synth1': { title: 'Synth√©tiseur', desc: 'G√©n√©rer sa premi√®re synth√®se.', icon: 'fa-file-signature', goal: 1, type: 'syntheses' },
            'quiz10': { title: 'Ma√Ætre Quizzeur', desc: 'Cr√©er 10 quiz.', icon: 'fa-brain', goal: 10, type: 'quizzes' },
            'generator25': { title: 'G√©n√©rateur en S√©rie', desc: 'G√©n√©rer 25 supports (quiz + synth√®ses).', icon: 'fa-industry', goal: 25, type: 'creations' },
            'ice-breaker': { title: 'Brise-Glace', desc: 'Poster son premier message sur le forum.', icon: 'fa-hand-sparkles', goal: 1, type: 'forum' },
            'samaritan': { title: 'Bon Samaritain', desc: 'Partager un quiz ou une synth√®se.', icon: 'fa-heart', goal: 1, type: 'shares' },
            'pillar': { title: 'Pilier de la Communaut√©', desc: 'Recevoir 10 "j\'aime" sur le forum.', icon: 'fa-users', goal: 10, type: 'likes' },
            'debater': { title: 'D√©batteur', desc: 'Participer √† 5 discussions diff√©rentes.', icon: 'fa-comments', goal: 5, type: 'forum' },
            'veteran': { title: 'V√©t√©ran du Blocus', desc: 'Se connecter chaque jour d\'une semaine d\'examens.', icon: 'fa-shield-alt', goal: 1, type: 'events' },
            'big-course': { title: 'Le Blocus, m√™me pas peur !', desc: 'Uploader un cours de plus de 100 pages.', icon: 'fa-book-dead', goal: 1, type: 'pages' },
            'curious': { title: 'Curieux / Curieuse', desc: '???', icon: 'fa-search', goal: 1, type: 'secrets' },
            'collector10': { title: 'Collectionneur', desc: 'D√©bloquer 10 autres badges.', icon: 'fa-trophy', goal: 10, type: 'unlocked' },
            'legend': { title: 'L√©gende du Campus', desc: 'D√©bloquer tous les autres badges.', icon: 'fa-star-of-david', goal: 49, type: 'unlocked' },
            'specialist': { title: 'Sp√©cialiste', desc: 'Cr√©er 5 quiz sur le m√™me cours.', icon: 'fa-chalkboard-teacher', goal: 5, type: 'mastery' },
            'expert': { title: 'Expert / Experte', desc: 'Obtenir +90% sur 3 quiz du m√™me cours.', icon: 'fa-microscope', goal: 3, type: 'mastery' },
            'word-master': { title: 'Ma√Ætre des Mots', desc: 'G√©n√©rer une synth√®se de plus de 1000 mots.', icon: 'fa-pen-fancy', goal: 1, type: 'syntheses' },
            'sprinter': { title: 'Sprinteur / Sprinteuse', desc: 'R√©pondre √† 20 questions en moins de 10 minutes.', icon: 'fa-bolt', goal: 1, type: 'timers' },
            'omniscient': { title: 'Omniscient', desc: 'R√©ussir un quiz dans 5 mati√®res diff√©rentes.', icon: 'fa-globe-europe', goal: 5, type: 'subjects' },
            'course10': { title: 'Archiviste', desc: 'Uploader 10 cours.', icon: 'fa-archive', goal: 10, type: 'courses' },
            'folder5': { title: 'Organisateur', desc: 'Cr√©er 5 dossiers avec au moins un cours chacun.', icon: 'fa-sitemap', goal: 5, type: 'folders' },
            'knowledge-is-power': { title: 'Le Savoir, c\'est le Pouvoir', desc: 'Avoir plus de 500 pages de cours au total.', icon: 'fa-book', goal: 500, type: 'pages' },
            'course25': { title: 'Biblioth√®que d\'Alexandrie', desc: 'Uploader 25 cours.', icon: 'fa-university', goal: 25, type: 'courses' },
            'quiz25': { title: 'Collectionneur de Quiz', desc: 'Avoir 25 quiz sauvegard√©s.', icon: 'fa-scroll', goal: 25, type: 'quizzes' },
            'mentor': { title: 'Mentor', desc: 'Aider un autre utilisateur sur le forum.', icon: 'fa-user-graduate', goal: 1, type: 'forum' },
            'influencer': { title: 'Influenceur', desc: 'Un de tes quiz partag√©s a √©t√© jou√© 20 fois.', icon: 'fa-chart-line', goal: 20, type: 'shares' },
            'trendsetter': { title: 'Cr√©ateur de Tendances', desc: 'Lancer une discussion qui re√ßoit 15 r√©ponses.', icon: 'fa-rocket', goal: 15, type: 'forum' },
            'collaborator': { title: 'Collaborateur', desc: 'Participer √† un projet de groupe.', icon: 'fa-handshake', goal: 1, type: 'forum' },
            'voter': { title: 'Le Peuple a parl√©', desc: 'Voter sur 10 sondages ou suggestions.', icon: 'fa-vote-yea', goal: 10, type: 'forum' },
            'procrastinator': { title: 'Procrastinateur', desc: '???', icon: 'fa-hourglass-half', goal: 1, type: 'secrets' },
            'firefighter': { title: 'Pompier du Blocus', desc: 'Uploader 3 cours en moins d\'une heure.', icon: 'fa-fire-extinguisher', goal: 3, type: 'burst' },
            'minimalist': { title: 'Minimaliste', desc: 'Cr√©er une synth√®se de moins de 100 mots.', icon: 'fa-feather-alt', goal: 1, type: 'syntheses' },
            'bug-hunter': { title: 'Bug Hunter', desc: '???', icon: 'fa-bug', goal: 1, type: 'secrets' },
            'year1': { title: 'Anniversaire d\'√âtudes', desc: 'Se connecter un an apr√®s son inscription.', icon: 'fa-birthday-cake', goal: 365, type: 'date' },
            'polymath': { title: 'Polymathe', desc: 'Uploader des cours dans 3 domaines diff√©rents.', icon: 'fa-atom', goal: 3, type: 'subjects' },
            'tough-choice': { title: 'Le Choix Difficile', desc: '???', icon: 'fa-balance-scale', goal: 1, type: 'secrets' },
            'faithful': { title: 'Fid√®le au Poste', desc: 'Se connecter depuis 3 appareils diff√©rents.', icon: 'fa-laptop-house', goal: 3, type: 'devices' },
            'collector25': { title: 'Grand Collectionneur', desc: 'D√©bloquer 25 autres badges.', icon: 'fa-gem', goal: 25, type: 'unlocked' },
            'master': { title: 'Ma√Ætre du Blocus', desc: 'D√©bloquer 49 autres badges.', icon: 'fa-hat-wizard', goal: 49, type: 'unlocked' },
        };
        
        const ui = {
            loading: document.getElementById('loading-profile'),
            content: document.getElementById('profile-content'),
            navLoggedIn: document.getElementById('nav-logged-in'),
            userMenuButton: document.getElementById('user-menu-button'),
            userMenu: document.getElementById('user-menu'),
            logoutButton: document.getElementById('logout-button'),
            badgeModal: document.getElementById('badge-modal'),
            closeBadgeModalBtn: document.getElementById('close-badge-modal'),
            chartFilters: document.getElementById('chart-period-filters'),
            activityTypeFilters: document.getElementById('activity-type-filters'),
            toggleBadgesBtn: document.getElementById('toggle-badges-btn'),
            badgesWrapper: document.getElementById('badges-wrapper'),
        };

        let allData = {};

        function showSuccessToast(badge) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'bg-yellow-500 text-gray-900 p-4 rounded-lg shadow-lg flex items-center space-x-3 animate-pulse';
            toast.innerHTML = `<i class="fas ${badge.icon} text-2xl"></i><div><p class="font-bold">Succ√®s d√©bloqu√© !</p><p>${badge.title}</p></div>`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 5000);
        }

        ui.userMenuButton.addEventListener('click', (e) => { e.stopPropagation(); ui.userMenu.classList.toggle('hidden'); });
        window.addEventListener('click', (e) => { if (ui.navLoggedIn && !ui.navLoggedIn.contains(e.target)) ui.userMenu.classList.add('hidden'); });
        ui.logoutButton.addEventListener('click', async () => { await signOut(auth); localStorage.removeItem('unlockedBadges'); window.location.href = '/index.html'; });
        ui.closeBadgeModalBtn.addEventListener('click', () => ui.badgeModal.classList.add('hidden'));

        function showBadgeModal(badgeId, stats) {
            const badge = allBadges[badgeId];
            if (!badge) return;
            const isUnlocked = (stats[badge.type] || 0) >= badge.goal;
            const isSecret = badge.desc === '???';
            document.getElementById('badge-modal-icon').className = `bg-gray-700 w-24 h-24 rounded-full flex items-center justify-center mx-auto border-4 ${isUnlocked ? 'border-indigo-500' : 'border-gray-600'} mb-4`;
            document.querySelector('#badge-modal-icon i').className = `fas ${badge.icon} text-4xl ${isUnlocked ? 'text-yellow-400' : 'text-gray-500'}`;
            document.getElementById('badge-modal-title').textContent = badge.title;
            document.getElementById('badge-modal-description').textContent = (isSecret && !isUnlocked) ? '???' : badge.desc;
            const progressContainer = document.getElementById('badge-modal-progress-container');
            if (badge.goal && (!isSecret || isUnlocked)) {
                const count = stats[badge.type] || 0;
                const progress = Math.min(Math.floor((count / badge.goal) * 100), 100);
                const progressBar = document.getElementById('badge-modal-progress-bar');
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                document.getElementById('badge-modal-progress-text').textContent = `${count} / ${badge.goal}`;
                progressContainer.classList.remove('hidden');
            } else {
                progressContainer.classList.add('hidden');
            }
            ui.badgeModal.classList.remove('hidden');
        }

        function renderBadges(stats) {
            const container = document.getElementById('badges-container');
            container.innerHTML = '';
            const previouslyUnlocked = JSON.parse(localStorage.getItem('unlockedBadges')) || [];
            const newlyUnlocked = [];
            let unlockedCount = 0;
            const unlockedBadges = [];
            const lockedBadges = [];

            for (const id in allBadges) {
                const badge = allBadges[id];
                const isUnlocked = (stats[badge.type] || 0) >= badge.goal;
                if(isUnlocked) {
                    unlockedCount++;
                    unlockedBadges.push({id, ...badge});
                } else {
                    lockedBadges.push({id, ...badge});
                }
                if (isUnlocked && !previouslyUnlocked.includes(id)) {
                    newlyUnlocked.push(id);
                    showSuccessToast(badge);
                }
            }

            [...unlockedBadges, ...lockedBadges].forEach(badge => {
                const isUnlocked = (stats[badge.type] || 0) >= badge.goal;
                const badgeEl = document.createElement('div');
                badgeEl.className = `badge ${!isUnlocked ? 'locked' : ''}`;
                badgeEl.onclick = () => showBadgeModal(badge.id, stats);
                badgeEl.innerHTML = `<div class="bg-gray-700 w-16 h-16 rounded-full flex items-center justify-center mx-auto border-4 ${isUnlocked ? 'border-indigo-500' : 'border-gray-600'}"><i class="fas ${badge.icon} text-2xl ${isUnlocked ? 'text-yellow-400' : 'text-gray-500'}"></i></div><p class="mt-2 font-semibold text-xs truncate">${badge.title}</p>`;
                container.appendChild(badgeEl);
            });
            
            stats.unlocked = unlockedCount;
            if (newlyUnlocked.length > 0) {
                localStorage.setItem('unlockedBadges', JSON.stringify([...previouslyUnlocked, ...newlyUnlocked]));
                renderBadges(stats);
            }
        }

        function renderChart() {
            const period = parseInt(ui.chartFilters.querySelector('.active').dataset.period, 10);
            const type = ui.activityTypeFilters.querySelector('.active').dataset.type;
            const dataSet = allData[type] || [];
            const ctx = document.getElementById('activity-chart').getContext('2d');
            const labels = [], data = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                labels.push(date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }));
                data.push(0);
            }

            dataSet.forEach(item => {
                const timestampField = item.createdAt || item.uploadedAt;
                if (!timestampField) return;
                const itemDate = new Date(timestampField);
                itemDate.setHours(0, 0, 0, 0);
                const diffDays = Math.floor((today - itemDate) / (1000 * 60 * 60 * 24));
                if (diffDays >= 0 && diffDays < period) {
                    data[(period - 1) - diffDays]++;
                }
            });

            if (window.myChart instanceof Chart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Cr√©ations', data, backgroundColor: 'rgba(99, 102, 241, 0.6)', borderColor: 'rgba(99, 102, 241, 1)', borderWidth: 1 }] },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af', stepSize: 1 }, grid: { color: '#4b5563' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function fetchProfileData(userId, userEmail) {
            try {
                const userRef = doc(db, 'users', userId);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) { window.location.href = '/onboarding.html'; return; }
                const profileData = userSnap.data();

                const coursesRef = collection(db, 'users', userId, 'courses');
                const foldersRef = collection(db, 'users', userId, 'folders');
                const quizzesRef = collection(db, 'users', userId, 'quizzes');

                const [coursesSnap, foldersSnap, quizzesSnap] = await Promise.all([
                    getDocs(coursesRef), getDocs(foldersRef), getDocs(quizzesRef)
                ]);
                
                allData = {
                    courses: coursesSnap.docs.map(d => d.data()),
                    folders: foldersSnap.docs.map(d => d.data()),
                    quizzes: quizzesSnap.docs.map(d => d.data()),
                };

                document.getElementById('user-name-header').textContent = profileData.firstName;
                document.getElementById('user-avatar-header').src = profileData.photoURL;
                document.getElementById('user-name').textContent = `${profileData.firstName} ${profileData.lastName}`;
                document.getElementById('user-school').textContent = profileData.school;
                document.getElementById('user-email').textContent = userEmail;
                document.getElementById('profile-picture-display').src = profileData.photoURL;

                const registrationDate = profileData.createdAt ? new Date(profileData.createdAt) : new Date();
                const daysSinceRegistration = Math.floor((new Date() - registrationDate) / (1000 * 60 * 60 * 24));
                const stats = {
                    courses: allData.courses.length,
                    folders: allData.folders.length,
                    quizzes: allData.quizzes.length,
                    date: daysSinceRegistration,
                    // ... autres stats √† 0
                };

                document.getElementById('stats-courses').textContent = stats.courses;
                document.getElementById('stats-folders').textContent = stats.folders;
                document.getElementById('stats-quizzes').textContent = stats.quizzes;

                renderBadges(stats);
                renderChart();

                ui.loading.classList.add('hidden');
                ui.content.classList.remove('hidden');
                ui.navLoggedIn.classList.remove('hidden');
                ui.navLoggedIn.classList.add('flex');

            } catch (error) {
                console.error("Erreur fetchProfileData:", error);
                ui.loading.innerHTML = `<p class="text-red-400">Impossible de charger le profil. V√©rifiez vos r√®gles de s√©curit√© Firebase.</p>`;
            }
        }

        ui.toggleBadgesBtn.addEventListener('click', (e) => {
            const wrapper = ui.badgesWrapper;
            wrapper.classList.toggle('expanded');
            e.currentTarget.innerHTML = wrapper.classList.contains('expanded') 
                ? 'Voir moins <i class="fas fa-chevron-up ml-1"></i>' 
                : 'Voir plus <i class="fas fa-chevron-down ml-1"></i>';
        });

        ui.activityTypeFilters.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                ui.activityTypeFilters.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderChart();
            }
        });

        ui.chartFilters.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                ui.chartFilters.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderChart();
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user && !user.isAnonymous) {
                fetchProfileData(user.uid, user.email);
            } else {
                window.location.href = '/login.html';
            }
        });
    </script>
</body>
</html>