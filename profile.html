<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Projet Blocus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 flex flex-col items-center">

    <!-- Header de navigation (optionnel, mais recommand√© pour la coh√©rence) -->
    <header class="flex justify-between items-center p-6 bg-gray-900 shadow-lg fixed w-full top-0 left-0 z-10">
        <a href="/index.html" class="flex items-center space-x-2">
            <img src="images/logo.png" onerror="this.onerror=null;this.src='https://firebasestorage.googleapis.com/v0/b/chatbot-playground-c0c32.appspot.com/o/opera_xnPtx6KH7F.png?alt=media&token=c191a3ec-80f0-466d-9788-b7f33d79047c';" alt="Logo Projet Blocus" class="h-10">
        </a>
        <nav>
             <a href="/index.html" class="text-gray-300 hover:text-white px-3 py-2 transition-colors duration-300">
                <i class="fas fa-arrow-left mr-2"></i>Accueil
            </a>
            <button id="logout-button-header" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 ml-4">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </nav>
    </header>

    <!-- Conteneur principal de la page de profil -->
    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-4xl border border-gray-700 mt-24">
        <!-- En-t√™te du profil -->
        <div class="flex flex-col md:flex-row items-center justify-between mb-8 pb-4 border-b border-gray-700">
            <div class="flex items-center mb-4 md:mb-0">
                <div class="relative w-24 h-24 rounded-full border-4 border-indigo-500 overflow-hidden cursor-pointer group hover:border-indigo-400 transition-colors duration-300">
                    <img id="profile-picture-display" src="https://placehold.co/96x96/4b5563/ffffff?text=üë§" alt="Photo de profil" class="w-full h-full object-cover">
                    <!-- Bouton pour modifier la photo -->
                    <div id="edit-photo-overlay" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 hidden">
                        <i class="fas fa-camera text-white text-2xl"></i>
                    </div>
                </div>
                <input type="file" id="profile-picture-input" accept="image/*" class="hidden">
                <div class="ml-4 text-left">
                    <div id="view-mode-name">
                        <h1 id="user-name" class="text-3xl font-bold">Chargement...</h1>
                        <p id="user-school" class="text-gray-400">Chargement...</p>
                    </div>
                    <div id="edit-mode-name" class="hidden space-y-2">
                        <div class="flex space-x-2">
                            <input type="text" id="edit-firstName" class="w-1/2 px-4 py-2 rounded-lg bg-gray-700 text-white border-2 border-gray-600 focus:outline-none focus:border-indigo-500" placeholder="Pr√©nom">
                            <input type="text" id="edit-lastName" class="w-1/2 px-4 py-2 rounded-lg bg-gray-700 text-white border-2 border-gray-600 focus:outline-none focus:border-indigo-500" placeholder="Nom">
                        </div>
                        <input type="text" id="edit-school" class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white border-2 border-gray-600 focus:outline-none focus:border-indigo-500" placeholder="Universit√©/√âcole">
                    </div>
                    <p id="user-email" class="text-gray-500 text-sm italic"></p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="edit-profile-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                    <i class="fas fa-pen mr-2"></i>Modifier
                </button>
                <button id="save-profile-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 hidden">
                    <i class="fas fa-save mr-2"></i>Sauvegarder
                </button>
                <button id="cancel-edit-button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 hidden">
                    <i class="fas fa-times mr-2"></i>Annuler
                </button>
            </div>
        </div>

        <!-- Corps de la page avec les informations d√©taill√©es -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Section des cours -->
            <div class="bg-gray-700 p-6 rounded-lg">
                <h3 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-book-open mr-2 text-indigo-400"></i>Mes cours</h3>
                <ul id="courses-list-view" class="space-y-2">
                    <li class="text-gray-400">Chargement des cours...</li>
                </ul>
                <!-- Mode √©dition des cours -->
                <div id="courses-edit-mode" class="hidden">
                    <div id="courses-container" class="space-y-2">
                        <!-- Les champs de cours seront ajout√©s ici dynamiquement -->
                    </div>
                    <button type="button" id="add-course-button" class="mt-2 text-indigo-400 hover:text-indigo-500 font-bold">
                        <i class="fas fa-plus-circle mr-1"></i> Ajouter un autre cours
                    </button>
                    <datalist id="course-suggestions"></datalist>
                </div>
            </div>
            
            <!-- Section des statistiques -->
            <div class="bg-gray-700 p-6 rounded-lg">
                <h3 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-chart-line mr-2 text-indigo-400"></i>Mes Pr√©f√©rences</h3>
                <div class="space-y-4">
                    <div>
                        <p class="text-gray-400">Type d'exercice pr√©f√©r√© :</p>
                        <p id="favorite-exercise" class="text-indigo-400 text-2xl font-bold mt-1">Chargement...</p>
                        <select id="edit-exerciseType" class="hidden mt-1 w-full px-4 py-2 rounded-lg bg-gray-700 text-white border-2 border-gray-600 focus:outline-none focus:border-indigo-500">
                            <option value="qcm">QCM</option>
                            <option value="resume">Synth√®se</option>
                            <option value="fillInTheBlanks">Texte √† trous</option>
                            <option value="all">Tous</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message box pour les notifications -->
    <div id="message-box" class="fixed bottom-4 right-4 bg-gray-700 text-white p-4 rounded-lg shadow-xl hidden z-50">
        <p id="message-text"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

        // Ta configuration Firebase que tu as fournie
        const firebaseConfig = {
            apiKey: "AIzaSyDz8qDCTZIkrIVBTw58nSgEG_xXCG_mXxw",
            authDomain: "projetblocus1.firebaseapp.com",
            projectId: "projetblocus1",
            storageBucket: "projetblocus1.appspot.com",
            messagingSenderId: "536093956243",
            appId: "1:536093956243:web:4fa7310f49cbf8db1f5566",
            measurementId: "G-W5WZXDHNTC"
        };

        let app;
        let auth;
        let db;
        let storage;
        let currentUserId = null;
        let originalProfileData = {};

        function showMessage(message) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        const toggleEditMode = (isEditing) => {
            const viewElements = document.querySelectorAll('#view-mode-name, #courses-list-view, #favorite-exercise');
            const editElements = document.querySelectorAll('#edit-mode-name, #courses-edit-mode, #edit-exerciseType, #save-profile-button, #cancel-edit-button, #edit-photo-overlay');

            viewElements.forEach(el => el.classList.toggle('hidden', isEditing));
            editElements.forEach(el => el.classList.toggle('hidden', !isEditing));
            document.getElementById('edit-profile-button').classList.toggle('hidden', isEditing);
        };

        const populateViewMode = (data) => {
            document.getElementById('user-name').textContent = `${data.firstName} ${data.lastName}`;
            document.getElementById('user-school').textContent = data.school;
            document.getElementById('user-email').textContent = auth.currentUser.email || 'N/A';
            document.getElementById('profile-picture-display').src = data.photoURL || `https://placehold.co/96x96/4b5563/ffffff?text=üë§`;
            
            const exerciseTypeMap = { qcm: 'QCM', resume: 'Synth√®se', fillInTheBlanks: 'Texte √† trous', all: 'Tous' };
            document.getElementById('favorite-exercise').textContent = exerciseTypeMap[data.favoriteExerciseType] || 'Non sp√©cifi√©';
            
            const coursesListView = document.getElementById('courses-list-view');
            coursesListView.innerHTML = '';
            if (data.courses && data.courses.length > 0) {
                data.courses.forEach(course => {
                    const li = document.createElement('li');
                    li.textContent = course;
                    li.className = 'text-gray-300 px-4 py-2 bg-gray-600 rounded-md';
                    coursesListView.appendChild(li);
                });
            } else {
                coursesListView.innerHTML = '<li class="text-gray-400">Aucun cours ajout√©.</li>';
            }
        };
        
        const populateEditMode = (data) => {
            document.getElementById('edit-firstName').value = data.firstName;
            document.getElementById('edit-lastName').value = data.lastName;
            document.getElementById('edit-school').value = data.school;
            document.getElementById('edit-exerciseType').value = data.favoriteExerciseType || 'all';

            const coursesEditContainer = document.getElementById('courses-container');
            coursesEditContainer.innerHTML = '';
            if (data.courses && data.courses.length > 0) {
                data.courses.forEach(course => addCourseInput(course));
            } else {
                addCourseInput('');
            }
            updateRemoveButtons();
        };

        const fetchUserProfile = async (userId) => {
            try {
                // Utilisation du chemin simplifi√© pour la coh√©rence
                const userRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    originalProfileData = docSnap.data();
                    populateViewMode(originalProfileData);
                    populateEditMode(originalProfileData);
                } else {
                    showMessage("Profil introuvable. Redirection...");
                    setTimeout(() => window.location.href = '/onboarding.html', 2000);
                }
            } catch (error) {
                console.error("Erreur lors de la r√©cup√©ration du profil:", error);
                showMessage("Erreur lors du chargement des donn√©es.");
            }
        };

        const addCourseInput = (value = '') => {
            const coursesContainer = document.getElementById('courses-container');
            const newCourseInput = document.createElement('div');
            newCourseInput.className = 'relative flex items-center course-input-wrapper';
            newCourseInput.innerHTML = `
                <input type="text" name="course" class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white border-2 border-gray-600 focus:outline-none focus:border-indigo-500" placeholder="Nom du cours" value="${value}" required>
                <button type="button" class="remove-course-button absolute right-2 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            `;
            coursesContainer.appendChild(newCourseInput);
        };

        const updateRemoveButtons = () => {
            const courseInputs = document.querySelectorAll('.course-input-wrapper');
            courseInputs.forEach(wrapper => {
                const removeButton = wrapper.querySelector('.remove-course-button');
                removeButton.classList.toggle('hidden', courseInputs.length <= 1);
            });
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
                showMessage("D√©connexion r√©ussie.");
                setTimeout(() => window.location.href = '/login.html', 1500);
            } catch (error) {
                console.error("Erreur lors de la d√©connexion:", error);
                showMessage("Erreur lors de la d√©connexion.");
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                onAuthStateChanged(auth, (user) => {
                    if (user && !user.isAnonymous) {
                        currentUserId = user.uid;
                        fetchUserProfile(currentUserId);
                    } else {
                        window.location.href = '/login.html';
                    }
                });

                document.getElementById('edit-profile-button').addEventListener('click', () => toggleEditMode(true));
                document.getElementById('cancel-edit-button').addEventListener('click', () => {
                    populateViewMode(originalProfileData); // Restaurer la vue
                    populateEditMode(originalProfileData); // Restaurer les champs
                    toggleEditMode(false);
                });

                const profilePictureInput = document.getElementById('profile-picture-input');
                document.getElementById('edit-photo-overlay').parentElement.addEventListener('click', () => {
                    if (!document.getElementById('edit-profile-button').classList.contains('hidden')) return;
                    profilePictureInput.click();
                });

                profilePictureInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => document.getElementById('profile-picture-display').src = e.target.result;
                        reader.readAsDataURL(file);
                    }
                });

                document.getElementById('save-profile-button').addEventListener('click', async () => {
                    const button = document.getElementById('save-profile-button');
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';

                    const updates = {
                        firstName: document.getElementById('edit-firstName').value,
                        lastName: document.getElementById('edit-lastName').value,
                        school: document.getElementById('edit-school').value,
                        favoriteExerciseType: document.getElementById('edit-exerciseType').value,
                        courses: Array.from(document.querySelectorAll('input[name="course"]')).map(input => input.value.trim()).filter(Boolean)
                    };
                    
                    const profilePictureFile = profilePictureInput.files[0];
                    try {
                        if (profilePictureFile) {
                            const storageRef = ref(storage, `users/${currentUserId}/profilePicture.jpg`);
                            await uploadBytes(storageRef, profilePictureFile);
                            updates.photoURL = await getDownloadURL(storageRef);
                        }
                        
                        const userRef = doc(db, 'users', currentUserId);
                        await updateDoc(userRef, updates);
                        
                        await fetchUserProfile(currentUserId); // Recharger les donn√©es
                        showMessage("Profil mis √† jour avec succ√®s !");
                        toggleEditMode(false);

                    } catch (error) {
                        console.error("Erreur lors de la mise √† jour du profil:", error);
                        showMessage("Erreur lors de la sauvegarde.");
                    } finally {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-save mr-2"></i>Sauvegarder';
                    }
                });

                document.getElementById('add-course-button').addEventListener('click', () => {
                    addCourseInput();
                    updateRemoveButtons();
                });

                document.getElementById('courses-container').addEventListener('click', (event) => {
                    if (event.target.closest('.remove-course-button')) {
                        event.target.closest('.course-input-wrapper').remove();
                        updateRemoveButtons();
                    }
                });

                document.getElementById('logout-button-header').addEventListener('click', handleLogout);
            } catch (error) {
                console.error("Erreur d'initialisation:", error);
                showMessage("Erreur critique de l'application.");
            }
        });
    </script>
</body>
</html>